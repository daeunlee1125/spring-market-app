<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.shoply.mapper.CartMapper">
    <select id="selectCartsByNos" parameterType="java.util.List" resultType="kr.co.shoply.dto.CartDTO">
        SELECT * FROM CART c
        JOIN PRO_FILE pf ON c.PROD_NO = pf.PROD_NO
        WHERE cart_no IN
        <foreach item="cart_no" collection="list" open="(" separator="," close=")">
            #{cart_no}
        </foreach>
        AND pf.F_DIST = 1
    </select>

    <resultMap id="cartWithProductMap" type="kr.co.shoply.dto.CartDTO">
        <id property="cart_no" column="CART_NO"/>
        <result property="mem_id" column="MEM_ID"/>
        <result property="cart_item_cnt" column="CART_ITEM_CNT"/>
        <result property="cart_option" column="CART_OPTION"/>
        <result property="prod_no" column="PROD_NO"/>
        <result property="fName" column="fName"/>

        <association property="productDTO" javaType="kr.co.shoply.dto.ProductDTO">
        <id property="prod_no" column="PROD_NO"/>
        <result property="prod_name" column="PROD_NAME"/>
        <result property="prod_company" column="PROD_COMPANY"/>
        <result property="prod_price" column="PROD_PRICE"/>
        <result property="prod_sale" column="PROD_SALE"/>
        <result property="prod_info" column="PROD_INFO"/>
        <result property="prod_deliv_price" column="PROD_DELIV_PRICE"/>
        <result property="prod_point" column="PROD_POINT"/>
        <result property="realPrice" column="realPrice"/>
        </association>
    </resultMap>

    <select id="selectCartList3" parameterType="string" resultMap="cartWithProductMap">
        SELECT
            c.CART_NO,
            c.MEM_ID,
            c.CART_ITEM_CNT,
            c.CART_OPTION,
            p.PROD_NO,
            p.PROD_NAME,
            p.PROD_COMPANY,
            p.PROD_PRICE,
            p.PROD_SALE,
            p.prod_info,
            p.PROD_DELIV_PRICE,
            p.PROD_POINT,
            p.PROD_PRICE - (p.PROD_PRICE * (p.PROD_SALE / 100)) AS realPrice,
            pf.F_NAME AS fName
        FROM
            CART c
        JOIN
            PRODUCT p ON c.PROD_NO = p.PROD_NO
        JOIN
            PRO_FILE pf ON c.PROD_NO  = pf.PROD_NO
        WHERE
            c.MEM_ID = #{mem_id} AND pf.F_DIST = 1
    </select>

    <select id="selectCartCount3" resultType="int">
        SELECT count(*)
        FROM CART
        WHERE MEM_ID = #{mem_id} AND PROD_NO = #{prod_no} AND CART_OPTION = #{cart_option}
    </select>

    <select id="selectCartIndex3" resultType="int">
        SELECT COUNT(*)
        FROM CART c
        WHERE c.MEM_ID = #{mem_id}
    </select>

    <insert id="insertCart3" parameterType="kr.co.shoply.dto.CartDTO">
        INSERT INTO CART(MEM_ID, PROD_NO, CART_ITEM_CNT, CART_OPTION)
        VALUES (
                #{mem_id},
                #{prod_no},
                #{cart_item_cnt},
                #{cart_option}
        )
    </insert>

    <delete id="deleteCart3" parameterType="kr.co.shoply.dto.CartDTO">
        DELETE FROM CART WHERE CART_NO=#{cart_no}
    </delete>

    <delete id="deleteSelectedCarts3" parameterType="java.util.List">
        DELETE FROM cart
        WHERE cart_no IN
        <foreach item="cart_no" collection="list" open="(" separator="," close=")">
            #{cart_no}
        </foreach>
    </delete>

    <update id="updateCartQuantity" parameterType="kr.co.shoply.dto.CartUpdateDTO">
        UPDATE cart
        SET cart_item_cnt = #{cart_item_cnt}
        WHERE cart_no = #{cart_no}
    </update>

</mapper>