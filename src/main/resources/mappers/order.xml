<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.shoply.mapper.OrderMapper">

    <select id="ordStatCnt2" resultType="kr.co.shoply.dto.AdInfoDTO">
        SELECT
        count(CASE WHEN ORD_STAT=1 THEN 1 end) as st1,
        count(CASE WHEN ORD_STAT=3 THEN 1 end) as st3,
        count(*) as ordNum,
        count(CASE WHEN TRUNC(ord_date) = TRUNC(SYSDATE) THEN 1 END) as todOrdNum,
        count(CASE WHEN TRUNC(ord_date) = TRUNC(SYSDATE - 1) THEN 1 END) as yesOrdNum,
        sum(ORD_TOTAL) as ordTotal,
        COALESCE(sum(CASE WHEN (TRUNC(ord_date) = TRUNC(SYSDATE)) THEN ord_total END), 0) as todOrdTotal,
        COALESCE(sum(CASE WHEN (TRUNC(ord_date) = TRUNC(SYSDATE - 1)) THEN ord_total END), 0) as yesOrdTotal
        FROM "order"
    </select>

    <select id="selectOrderNo3" resultType="kr.co.shoply.dto.OrderDTO">
        SELECT *
        FROM "order"
        WHERE MEM_ID = #{mem_id}
        ORDER BY ORD_DATE DESC
        FETCH FIRST 1 ROW ONLY
    </select>

    <select id="selectOrderById" resultType="kr.co.shoply.dto.OrderDTO">
        SELECT *
        FROM "order"
        WHERE ORD_NO = #{ord_no}
    </select>

    <insert id="insertOrder3">
        INSERT INTO "order"(MEM_ID, ORD_NAME, ORD_HP, ORD_ZIP, ORD_ADDR1, ORD_ADDR2, ORD_PAYMENT, ORD_TOTAL, ORD_DATE, ORD_STAT)
        VALUES (#{mem_id}, #{ord_name}, #{ord_hp}, #{ord_zip}, #{ord_addr1}, #{ord_addr2}, #{ord_payment}, #{ord_total}, SYSDATE, 2)
    </insert>

    <resultMap id="orderItemWithProductMap" type="kr.co.shoply.dto.OrderItemDTO">
        <id property="item_no" column="ITEM_NO"/>
        <result property="ord_no" column="ORD_NO"/>
        <result property="prod_no" column="PROD_NO"/>
        <result property="item_name" column="ITEM_NAME"/>
        <result property="item_cnt" column="ITEM_CNT"/>
        <result property="item_stat" column="ITEM_STAT"/>
        <result property="prod_option" column="PROD_OPTION"/>

        <association property="product" javaType="kr.co.shoply.dto.ProductDTO">
            <id property="prod_no" column="PROD_NO"/>
            <result property="cate2_no" column="CATE2_NO"/>
            <result property="prod_name" column="PROD_NAME"/>
            <result property="prod_info" column="PROD_INFO"/>
            <result property="prod_company" column="PROD_COMPANY"/>
            <result property="mem_id" column="MEM_ID"/>
            <result property="prod_price" column="PROD_PRICE"/>
            <result property="prod_sale" column="PROD_SALE"/>
            <result property="prod_deliv_price" column="PROD_DELIV_PRICE"/>
            <result property="prod_point" column="PROD_POINT"/>
            <result property="prod_stock" column="PROD_STOCK"/>
            <result property="prod_sold" column="PROD_SOLD"/>
            <result property="prod_hit" column="PROD_HIT"/>
        </association>
    </resultMap>

    <resultMap id="completeOrderResultMap" type="kr.co.shoply.dto.CompleteDTO">
        <association property="order" javaType="kr.co.shoply.dto.OrderDTO">
            <result property="ord_no" column="ORD_NO"/>
            <result property="mem_id" column="MEM_ID"/>
            <result property="ord_name" column="ORD_NAME"/>
            <result property="ord_hp" column="ORD_HP"/>
            <result property="ord_zip" column="ORD_ZIP"/>
            <result property="ord_addr1" column="ORD_ADDR1"/>
            <result property="ord_addr2" column="ORD_ADDR2"/>
            <result property="ord_total" column="ORD_TOTAL"/>
            <result property="ord_date" column="ORD_DATE"/>
            <result property="ord_payment" column="ORD_PAYMENT"/>
        </association>

        <collection property="orderItems" ofType="kr.co.shoply.dto.OrderItemDTO" resultMap="orderItemWithProductMap"/>
    </resultMap>

    <select id="selectCompleteOrder3" resultMap="completeOrderResultMap">
        SELECT *
        FROM "order" o
        JOIN ORDER_ITEM oi ON o.ORD_NO = oi.ORD_NO
        JOIN PRODUCT p ON oi.PROD_NO = p.PROD_NO
        WHERE o.ORD_NO = #{ord_no}
    </select>

    <insert id="insertOrderItemList3" parameterType="java.util.List">
        INSERT ALL
        <foreach item="item" collection="orderItemDTOList">
            INTO ORDER_ITEM (ORD_NO, PROD_NO, ITEM_NAME, ITEM_CNT, ITEM_STAT, PROD_OPTION)
            VALUES
            (
                #{item.ord_no},
                #{item.prod_no},
                #{item.item_name},
                #{item.item_cnt},
                0,
                #{item.prod_option, jdbcType=VARCHAR}
            )
        </foreach>
        SELECT 1 FROM DUAL
    </insert>

    <select id="getOrderList2" resultType="kr.co.shoply.dto.OrderDTO">
        SELECT
        ord_no,
        m.mem_id,
        mem_name,
        ITEM_CNT,
        sum(prod_price * (100-prod_sale)/100) AS ord_total,
        prod_no,
        ord_payment,
        ord_stat,
        ord_date,
        ord_name,
        item_no,
        ord_hp,
        ord_addr1,
        ord_addr2
        FROM "order" o
        JOIN MEMBER m ON m.mem_id = o.MEM_ID
        JOIN order_item i USING (ord_no)
        JOIN product p USING (prod_no)
        <include refid="searchWhere2"/>
        GROUP BY ord_no, m.mem_id, mem_name, item_cnt, prod_no, ord_payment, ord_stat, ord_date, ord_name, item_no, ord_hp, ord_addr1, ord_addr2
        ORDER BY ord_no DESC
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <sql id="searchWhere2">
        <where>
            <if test="searchType != null and keyword != ''">
                <choose>
                    <when test="searchType == 'ord_no'">
                        ord_no LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="searchType == 'mem_name'">
                        mem_name LIKE '%' || #{keyword} || '%'
                    </when>
                    <when test="searchType == 'mem_id'">
                        mem_id LIKE '%' || #{keyword} || '%'
                    </when>

                </choose>
            </if>
        </where>
    </sql>

    <select id="selectCountTotal2" resultType="int">
        SELECT COUNT(*) FROM Order_item i
        Join "order" o on o.ord_no = i.ord_no
        Join member m on m.mem_id = o.mem_id
        <include refid="searchWhere2"/>
    </select>

    <select id="getOrderDetails2" resultType="kr.co.shoply.dto.OrderDTO">
        SELECT
        item_no,
        ord_no,
        o.mem_id,
        prod_name,
        ITEM_CNT,
        prod_price,
        prod_sale,
        ord_payment,
        ord_stat,
        ord_name,
        ord_hp,
        ord_zip,
        ord_addr1,
        ord_addr2,
        prod_no,
        corp_name,
        sum((prod_price * (100-prod_sale)/100) * item_cnt)+prod_deliv_price AS ord_total,
        prod_deliv_price,
        f_name
        FROM "order" o
        JOIN order_item i USING (ord_no)
        JOIN product p USING (prod_no)
        JOIN MEMBER m ON m.mem_id = p.MEM_ID
        JOIN mem_seller s ON m.mem_id = s.MEM_ID
        JOIN PRO_FILE pf USING (prod_no)
        where f_dist=1
        GROUP BY ord_no, o.mem_id, prod_name, mem_name, item_cnt, prod_no, corp_name, f_name,
        prod_price, prod_sale, ord_payment, ord_stat, ord_name, ord_hp, ord_zip, ord_addr1, ord_addr2, prod_deliv_price, item_no
    </select>

</mapper>