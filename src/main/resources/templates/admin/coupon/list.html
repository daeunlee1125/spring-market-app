<div th:replace="~{admin/coupon/_head.html}"></div>

<div class="main">
    <div class="middle main-content">
        <div class="main-common">

            <!-- 상단 제목/네비 -->
            <div class="main-head">
                <div><h3>쿠폰목록</h3></div>
                <div class="main-head-right">
                    <a href="#">HOME</a><div>&nbsp;>&nbsp;</div>
                    <a href="#">쿠폰관리</a><div>&nbsp;>&nbsp;</div>
                    <a href="#" class="nav-last">쿠폰목록</a>
                </div>
            </div>

            <div class="main-content-top"></div>

            <!-- 검색 영역 -->
            <div class="sub-top">
                <div class="search-bar">
                    <form th:action="@{/admin/coupon/list}" method="get">
                        <select name="searchType">
                            <option value="code" th:selected="${pageResponse.searchType == 'code'}">쿠폰번호</option>
                            <option value="name" th:selected="${pageResponse.searchType == 'name'}">쿠폰명</option>
                            <option value="issuer" th:selected="${pageResponse.searchType == 'issuer'}">발급자</option>
                        </select>
                        <div class="search-place">
                            <input type="text" name="keyword" placeholder="검색어 입력"
                                   th:value="${pageResponse.keyword}">
                        </div>
                        <button type="submit">검색</button>
                    </form>
                </div>
            </div>

            <!-- 쿠폰목록 테이블 -->
            <table class="table coupon-list-table">
                <thead>
                <tr>
                    <th>쿠폰번호</th>
                    <th>쿠폰종류</th>
                    <th>쿠폰명</th>
                    <th>혜택</th>
                    <th>사용기간</th>
                    <th>발급자</th>
                    <th>발급수</th>
                    <th>사용수</th>
                    <th>상태</th>
                    <th>발급일</th>
                    <th>관리</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="coupon : ${pageResponse.dtoList}">
                    <td>
                        <a href="#" class="openModalBtn"
                           th:data-target="'couponDetailModal-' + ${coupon.cp_code}"
                           th:text="${coupon.cp_code}"></a>
                    </td>

                    <!-- 쿠폰종류 숫자 → 텍스트 -->
                    <td th:switch="${coupon.cp_type}">
                        <span th:case="1">개별상품 할인</span>
                        <span th:case="2">주문상품 할인</span>
                        <span th:case="3">배송비 무료</span>
                        <span th:case="*">기타</span>
                    </td>

                    <td th:text="${coupon.cp_name}">쿠폰명</td>
                    <td th:text="${coupon.cp_type == 3 ? '배송비 무료'
                    : (coupon.cp_type == 1 or coupon.cp_type == 2) ?
                       (coupon.cp_value + (coupon.cp_value <= 100 ? '%' : '원') + ' 할인') : ''}">
                    </td>

                    <td th:text="${coupon.cp_issue_date != null && coupon.cp_exp_date != null ?
                  #temporals.format(coupon.cp_issue_date, 'yyyy-MM-dd') + ' ~ ' + #temporals.format(coupon.cp_exp_date, 'yyyy-MM-dd')
                  : '기간 정보 없음'}">
                    </td>



                    <td th:text="${coupon.cp_issuer_name}"></td>
                    <td th:text="${coupon.issuecount}">0</td>
                    <td th:text="${coupon.usedcount}">0</td>
                    <td th:text="${coupon.cp_stat == 1 ? '발급중' : '종료'}"
                        th:style="${coupon.cp_stat == 1 ? 'color:green;' : 'color:red;'}"></td>
                    <td th:text="${#temporals.format(coupon.cp_issue_date, 'yyyy-MM-dd')}"></td>
                    <td>
                        <button th:if="${coupon.cp_stat == 1}"
                                class="openModalBtn register-btn small-btn"
                                data-target="confirmEndModal"
                                th:data-code="${coupon.cp_code}">
                            종료
                        </button>
                        <button th:if="${coupon.cp_stat == 0}"
                                class="register-btn small-btn"
                                style="background-color:#ccc; cursor:not-allowed;" disabled>
                            종료됨
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>

            <div class="page">
                <a th:if="${pageResponse.prev}"
                   th:href="@{/admin/coupon/list(pg=${pageResponse.start-1}, size=${pageResponse.size}, searchType=${pageResponse.searchType}, keyword=${pageResponse.keyword})}"
                   class="prev">이전</a>

                <a th:each="num : ${#numbers.sequence(pageResponse.start, pageResponse.end)}"
                   th:href="@{/admin/coupon/list(pg=${num}, size=${pageResponse.size}, searchType=${pageResponse.searchType}, keyword=${pageResponse.keyword})}"
                   th:classappend="${num == pageResponse.pg} ? 'current'"
                   th:text="${num}"></a>

                <a th:if="${pageResponse.next}"
                   th:href="@{/admin/coupon/list(pg=${pageResponse.end+1}, size=${pageResponse.size}, searchType=${pageResponse.searchType}, keyword=${pageResponse.keyword})}"
                   class="next">다음</a>
            </div>

            <div style="text-align:right; margin:15px 0 60px 0;">
                <button class="openModalBtn register-btn" data-target="couponRegisterModal">쿠폰등록</button>
            </div>

    </div>
</div>

<div th:replace="~{admin/coupon/_tail.html}"></div>

<!-- ================== 모달 ================== -->
<div th:each="coupon : ${pageResponse.dtoList}">
    <div class="modal hidden" th:id="'couponDetailModal-' + ${coupon.cp_code}">
        <div class="modal-popup large">
            <div class="modal-header">
                <h2>쿠폰정보 <span th:text="${coupon.cp_code}"></span></h2>
                <span class="closeModalBtn">&times;</span>
            </div>
            <div class="modal-content">
                <table class="table coupon-detail">
                    <tr>
                        <th>쿠폰번호</th>
                        <td th:text="${coupon.cp_code}"></td>
                        <th>발급처</th>
                        <td th:text="${coupon.cp_issuer_name != null ? coupon.cp_issuer_name : ''}"></td>
                    </tr>
                    <tr>
                        <th>쿠폰종류</th>
                        <td colspan="3" th:switch="${coupon.cp_type}">
                            <span th:case="1">개별상품 할인</span>
                            <span th:case="2">주문상품 할인</span>
                            <span th:case="3">배송비 무료</span>
                            <span th:case="*">기타</span>
                        </td>
                    </tr>
                    <tr>
                        <th>쿠폰명</th>
                        <td colspan="3" th:text="${coupon.cp_name}"></td>
                    </tr>
                    <tr>
                        <th>혜택</th>
                        <td colspan="3"
                            th:text="${coupon.cp_type == 3 ?
                  '배송비 무료' :
                  (coupon.cp_type == 1 || coupon.cp_type == 2 ?
                      (coupon.cp_value <= 100 ? coupon.cp_value + '%' : coupon.cp_value + '원') + ' 할인'
                      : '')}">
                        </td>
                    </tr>

                    <tr>
                        <th>사용기간</th>
                        <td colspan="3"
                            th:text="${#temporals.format(coupon.cp_issue_date, 'yyyy-MM-dd') + ' ~ ' + #temporals.format(coupon.cp_exp_date, 'yyyy-MM-dd')}"></td>

                    <tr>
                        <th>유의사항</th>
                        <td colspan="3" th:text="${coupon.cp_note}"></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>


<!-- 종료 확인 모달 -->
<div class="modal hidden" id="confirmEndModal">
    <div class="modal-popup">
        <div class="modal-header">
            <h2>쿠폰 종료 확인</h2>
            <span class="closeModalBtn">&times;</span>
        </div>
        <div class="modal-content">
            <p>해당 쿠폰의 발급을 종료하시겠습니까?</p>
            <div style="text-align:center; margin-top:20px;">
                <button id="confirmEndBtn" class="register-btn">확인</button>
                <button class="closeModalBtn delete-btn">취소</button>
            </div>
        </div>
    </div>
</div>


<!-- 쿠폰 등록 모달 -->
<div class="modal hidden" id="couponRegisterModal">
    <div class="modal-popup large">
        <div class="modal-header">
            <h2>쿠폰등록</h2>
            <button class="closeModalBtn">&times;</button>
        </div>
        <div class="modal-content">
            <form id="couponRegisterForm">

                <!-- 발급처 -->
                <div class="form-group">
                    <label>발급처</label>
                    <input type="text" th:value="${issuerName}" readonly>
                </div>

                <!-- 쿠폰종류 -->
                <div class="form-group">
                    <label>쿠폰종류</label>
                    <select name="cp_type" required>
                        <option value="">종류선택</option>
                        <!-- 일반 판매자(MEM_LEVEL == 2): 개별상품 할인만 가능 -->
                        <option th:if="${memLevel == 2}" value="1">개별상품 할인</option>
                        <!-- 최고 관리자(MEM_LEVEL == 7): 주문상품 할인, 배송비 무료만 가능 -->
                        <option th:if="${memLevel == 7}" value="2">주문상품 할인</option>
                        <option th:if="${memLevel == 7}" value="3">배송비 무료</option>
                    </select>
                </div>

                <!-- 쿠폰명 -->
                <div class="form-group">
                    <label>쿠폰명</label>
                    <input type="text" name="cp_name" placeholder="쿠폰명을 입력하세요" required>
                </div>

                <!-- 혜택 -->
                <div class="form-group">
                    <label>혜택</label>
                    <div>
                        <!--  일반판매자: 금액 할인만 -->
                        <div th:if="${memLevel == 2}">
                            <label><input type="radio" name="cp_value" value="1000"> 1,000원 할인</label>
                            <label><input type="radio" name="cp_value" value="2000"> 2,000원 할인</label>
                            <label><input type="radio" name="cp_value" value="3000"> 3,000원 할인</label>
                            <label><input type="radio" name="cp_value" value="4000"> 4,000원 할인</label>
                            <label><input type="radio" name="cp_value" value="5000"> 5,000원 할인</label>
                        </div>

                        <!-- 최고관리자 (주문상품 할인: %형 / 배송비 무료) -->
                        <div th:if="${memLevel == 7}">
                            <label><input type="radio" name="cp_value" value="10"> 10% 할인</label>
                            <label><input type="radio" name="cp_value" value="20"> 20% 할인</label>
                            <label><input type="radio" name="cp_value" value="30"> 30% 할인</label>
                            <label><input type="radio" name="cp_value" value="40"> 40% 할인</label>
                            <label><input type="radio" name="cp_value" value="50"> 50% 할인</label><br>
                            <label><input type="radio" name="cp_value" value="0">  배송비 무료</label>
                        </div>
                    </div>

                </div>
                <!-- 사용기간 -->
                <div class="form-group">
                    <label>사용기간</label>
                    <div>
                        <input type="date" name="cp_issue_date" required> ~
                        <input type="date" name="cp_exp_date" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>유의사항</label>
                    <textarea name="cp_note" placeholder="유의사항을 입력하세요" rows="4" style="width:100%; resize:none;"></textarea>
                </div>


                <!-- 숨김값 -->
                <input type="hidden" name="cp_stat" value="1"> <!-- 기본값 발급중 -->
                <input type="hidden" name="cp_min_price" value="0"> <!-- 최소사용금액 기본 0 -->

                <!-- 버튼 -->
                <div style="text-align:center; margin-top:20px;">
                    <button type="button" class="closeModalBtn delete-btn">취소</button>
                    <button type="submit" class="register-btn">등록</button>
                </div>
            </form>
        </div>
    </div>
</div>




<script>
    let targetCouponBtn = null;   // 종료 버튼 대상
    let targetCouponCode = null;  // 종료할 쿠폰 코드

    document.addEventListener("DOMContentLoaded", () => {
        // ================= 종료 모달 =================
        document.querySelectorAll(".openModalBtn").forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                const targetId = btn.dataset.target;
                document.getElementById(targetId).classList.remove("hidden");

                if (targetId === "confirmEndModal" && btn.dataset.code) {
                    targetCouponBtn = btn;
                    targetCouponCode = btn.dataset.code;
                }
            });
        });

        document.querySelectorAll(".modal").forEach(modal => {
            modal.addEventListener("click", (e) => {
                if (e.target.classList.contains("closeModalBtn") || e.target === modal) {
                    modal.classList.add("hidden");
                }
            });
        });

        document.getElementById("confirmEndBtn").addEventListener("click", () => {
            if (!targetCouponCode) return;

            fetch("[[@{/admin/coupon/end}]]", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "cp_code=" + targetCouponCode
            })
                .then(res => res.text())
                .then(result => {
                    if (result === "success") {
                        targetCouponBtn.textContent = "종료됨";
                        targetCouponBtn.disabled = true;
                        targetCouponBtn.style.backgroundColor = "#ccc";
                        targetCouponBtn.style.cursor = "not-allowed";

                        const row = targetCouponBtn.closest("tr");
                        const statusCell = row.querySelector("td:nth-child(9)");
                        statusCell.textContent = "종료";
                        statusCell.style.color = "red";
                    }
                })
                .finally(() => {
                    document.getElementById("confirmEndModal").classList.add("hidden");
                    targetCouponBtn = null;
                    targetCouponCode = null;
                });
        });

        // ================= 등록 모달 =================
        const registerForm = document.getElementById("couponRegisterForm");
        if (registerForm) {
            registerForm.addEventListener("submit", (e) => {
                e.preventDefault();

                const formData = new FormData(registerForm);

                fetch("[[@{/admin/coupon/register}]]", {
                    method: "POST",
                    body: new URLSearchParams(formData)
                })
                    .then(res => res.text())
                    .then(result => {
                        if (result === "success") {
                            alert("쿠폰이 등록되었습니다.");
                            location.reload();
                        } else {
                            alert("등록 실패");
                        }
                    })
                    .catch(err => console.error(err));
            });
        }
    });
</script>



