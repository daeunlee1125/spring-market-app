
<div th:replace="~{admin/member/_head.html}"></div>

<div class="main">
    <div class="middle main-content">
        <div class="main-common">
            <div class="main-head">
                <div>
                    <h3>포인트관리</h3>
                </div>
                <div class="main-head-right">
                    <a th:href="@{/admin}">HOME</a>
                    <div>&nbsp;>&nbsp;</div>
                    <a th:href="@{/admin/member/list}">회원관리</a>
                    <div>&nbsp;>&nbsp;</div>
                    <a class="nav-last">포인트관리</a>
                </div>
            </div>


            <div class="main-content-top"></div>


            <main>
                <!-- 검색 영역 -->
                <div class="sub-top">
                    <div class="search-bar">
                        <form th:action="@{/admin/member/point}" method="get">
                            <select name="searchType">
                                <option value="mem_id" th:selected="${pageRequestDTO.searchType == 'mem_id'}">아이디</option>
                                <option value="mem_name" th:selected="${pageRequestDTO.searchType == 'mem_name'}">이름</option>
                                <option value="mem_email" th:selected="${pageRequestDTO.searchType == 'mem_email'}">이메일</option>
                                <option value="mem_hp" th:selected="${pageRequestDTO.searchType == 'mem_hp'}">휴대폰</option>
                            </select>

                            <div class="search-place">
                                <input type="text" name="keyword" placeholder="검색어 입력"
                                       th:value="${pageRequestDTO.keyword}">
                            </div>

                            <button type="submit">검색</button>
                        </form>
                    </div>
                </div>


                <!-- 포인트 테이블 -->
                <table class="table">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="chkAll"></th>
                        <th>번호</th>
                        <th>아이디</th>
                        <th>이름</th>
                        <th>지급 포인트</th>
                        <th>잔여 포인트</th>
                        <th>지급 내용</th>
                        <th>지급 날짜</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:each="point, stat : ${pointList}">
                        <td><input type="checkbox" class="chkPoint" th:value="${point.p_no}"></td>
                        <td th:text="${point.p_no}"></td>
                        <td th:text="${point.mem_id}"></td>
                        <td th:text="${point.mem_name}"></td>
                        <td th:text="${#numbers.formatInteger(point.p_point, 0, 'COMMA')}"></td>
                        <td th:text="${#numbers.formatInteger(point.remain_point, 0, 'COMMA')}"></td>
                        <td th:text="${point.p_info}"></td>
                        <td th:text="${point.p_date}"></td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(pointList)}">
                        <td colspan="8" style="text-align:center;">포인트 내역이 없습니다.</td>
                    </tr>
                    </tbody>
                </table>

                <div class="bottom-btn-area" style="margin-top: 20px; text-align: center;">
                    <button type="button" class="member-edit-btn" id="btnDeleteSelected">선택삭제</button>
                </div>





                <!-- 페이지네이션 버튼 -->
                <div class="page">
                    <a th:if="${pageResponseDTO.prev}"
                       th:href="@{/admin/member/point(pg=${pageResponseDTO.start - 1})}"
                       class="prev">이전</a>

                    <a th:each="i : ${#numbers.sequence(pageResponseDTO.start, pageResponseDTO.end)}"
                       th:href="@{/admin/member/point(pg=${i})}"
                       th:text="${i}"
                       th:classappend="${i == pageResponseDTO.pg} ? ' current' : ''"
                       class="num">1</a>

                    <a th:if="${pageResponseDTO.next}"
                       th:href="@{/admin/member/point(pg=${pageResponseDTO.end + 1})}"
                       class="next">다음</a>
                </div>

            </main>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const chkAll = document.getElementById("chkAll");
        const chkBoxes = document.querySelectorAll(".chkPoint");
        const btnDelete = document.getElementById("btnDeleteSelected");

        //  전체선택 체크박스 제어
        chkAll.addEventListener("change", function() {
            chkBoxes.forEach(chk => chk.checked = chkAll.checked);
        });

        // 개별 체크 시 전체선택 여부 갱신
        chkBoxes.forEach(chk => {
            chk.addEventListener("change", function() {
                chkAll.checked = Array.from(chkBoxes).every(c => c.checked);
            });
        });

        //  선택 삭제 기능
        btnDelete.addEventListener("click", function() {
            const selected = Array.from(chkBoxes)
                .filter(chk => chk.checked)
                .map(chk => chk.value);

            if (selected.length === 0) {
                alert("삭제할 포인트를 선택하세요.");
                return;
            }

            if (!confirm(`${selected.length}개의 포인트 내역을 삭제하시겠습니까?`)) {
                return;
            }

            fetch("/shoply/admin/member/point/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(selected)
            })
                .then(response => {
                    if (response.ok) {
                        alert("선택한 포인트가 삭제되었습니다.");
                        location.reload();
                    } else {
                        alert("삭제 중 오류가 발생했습니다.");
                    }
                })
                .catch(err => {
                    console.error("서버 요청 실패:", err);
                    alert("서버 요청 실패");
                });
        });
    });
</script>




<div th:replace="~{admin/member/_tail.html}"></div>
</body>
</html>
