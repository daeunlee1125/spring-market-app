<!-- home.html -->
<div th:replace="~{my/_head.html}"></div>

<main class="container">
    <div class="sidebar">
        <ul>
            <li><a th:href="@{/my/home}" class="active">마이페이지 홈</a></li>
            <li><a th:href="@{/my/order}">전체주문내역</a></li>
            <li><a th:href="@{/my/point}">포인트내역</a></li>
            <li><a th:href="@{/my/coupon}">쿠폰</a></li>
            <li><a th:href="@{/my/review}">나의리뷰</a></li>
            <li><a th:href="@{/my/qna}">문의하기</a></li>
            <li><a th:href="@{/my/info}">나의설정</a></li>
        </ul>
    </div>

    <div class="content">
        <!-- 쇼핑 요약 -->
        <div class="main-content-header">
            <h2>나의 쇼핑 정보</h2>
            <div class="info-summary">
                <div class="info-item">
                    <div class="count" th:text="${orderCount}">0</div>
                    <div>주문</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${couponCount}">0</div>
                    <div>쿠폰</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${#numbers.formatInteger(pointTotal, 0, 'COMMA')}">0</div>
                    <div>포인트</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${qnaCount}">0</div>
                    <div>문의</div>
                </div>
            </div>
        </div>

        <!-- 배너 -->
        <div style="width: 810px; height: 86px; background-color: #eee; text-align: center; line-height: 86px; margin-bottom: 20px;">
            810 x 86 배너 광고
        </div>

        <!-- 최근 주문내역 -->
        <div class="section">
            <div class="section-header">
                <h3>최근 주문내역</h3>
            </div>
            <table class="table-container">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th>상품정보</th>
                    <th>상태</th>
                    <th>확인 / 신청</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="orderItem : ${recentOrders}">
                    <td th:text="${#dates.format(orderItem.ord_date, 'yyyy-MM-dd')}">2022-12-13</td>
                    <td>
                        <div class="product-info">
                            <img th:if="${productMap[orderItem.prod_no] != null
                                  and productMap[orderItem.prod_no].files != null
                                  and productMap[orderItem.prod_no].files.size() > 0}"
                                 th:src="@{'/uploads/' + ${productMap[orderItem.prod_no].files[0].f_name}}"
                                 alt="상품 이미지"/>
                            <img th:if="${productMap[orderItem.prod_no] == null
                                  or productMap[orderItem.prod_no].files == null
                                  or productMap[orderItem.prod_no].files.size() == 0}"
                                 th:src="@{'/image/product/cap_3_thumb2.jpg'}"
                                 alt="기본 상품 이미지"/>
                            <div class="product-details">
                                <p>주문번호 :
                                    <a href="#"
                                       class="order-number-link"
                                       th:text="${orderItem.ord_no}"
                                       th:data-ord-no="${orderItem.ord_no}"
                                       th:data-item-no="${orderItem.item_no}"></a>
                                </p>
                                <p>(주) <a href="#" onclick="openModal('sellerInfoPopup')">상호명</a></p>
                                <span th:text="${productMap[orderItem.prod_no].prod_name}">상품명</span>
                                <p>수량 : <span th:text="${orderItem.item_cnt}">1</span>개</p>
                                <strong th:if="${productMap[orderItem.prod_no] != null}"
                                        th:text="${#numbers.formatInteger(productMap[orderItem.prod_no].prod_price, 0, 'COMMA')} + '원'">
                                    가격정보
                                </strong>
                                <strong th:if="${productMap[orderItem.prod_no] == null}">가격 정보 없음</strong>
                            </div>
                        </div>
                    </td>
                    <td th:switch="${orderItem.item_stat}">
                        <span th:case="0">결제완료</span>
                        <span th:case="1">배송준비</span>
                        <span th:case="2">배송중</span>
                        <span th:case="3">배송완료</span>
                        <span th:case="4">구매확정</span>
                        <span th:case="5">교환신청</span>
                        <span th:case="6">반품신청</span>
                        <span th:case="*">상태없음</span>
                    </td>
                    <!-- home.html의 최근 주문내역 테이블 부분 -->
                    <td>
                        <br>
                        <button class="btn-confirm"
                                th:data-item-no="${orderItem.item_no}"
                                th:disabled="${orderItem.item_stat >= 4}">구매확정</button>
                        <button class="btn-review"
                                th:data-prod-no="${orderItem.prod_no}"
                                th:data-prod-name="${orderItem.item_name}"
                                th:disabled="${orderItem.item_stat < 4}">상품평쓰기</button>
                        <button class="btn-return"
                                th:data-item-no="${orderItem.item_no}"
                                th:disabled="${orderItem.item_stat != 3}">반품신청</button>
                        <button class="btn-exchange"
                                th:data-item-no="${orderItem.item_no}"
                                th:disabled="${orderItem.item_stat != 3}">교환신청</button>
                        <br>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(recentOrders)}">
                    <td colspan="4" style="text-align: center;">최근 주문 내역이 없습니다.</td>
                </tr>
                </tbody>
            </table>
            <br>
            <a th:href="@{/my/order}" class="more-link">더보기 &gt;</a>
        </div>

        <!-- 포인트 내역 -->
        <div class="section">
            <div class="section-header">
                <h3>포인트적립내역</h3>
            </div>
            <table class="table-container">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th>구분</th>
                    <th>주문번호</th>
                    <th>적립금액</th>
                    <th>비고</th>
                    <th>유효기간</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="point : ${recentPoints}">
                    <td th:text="${point.p_date}"></td>
                    <td>
                        <span th:if="${point.p_type == 1}">적립</span>
                        <span th:if="${point.p_type == 2}">사용</span>
                        <span th:unless="${point.p_type == 1 or point.p_type == 2}">기타</span>
                    </td>
                    <td th:text="${point.ord_no}"></td>
                    <td th:text="${#numbers.formatInteger(point.p_point, 0, 'COMMA')}"></td>
                    <td th:text="${point.p_info}"></td>
                    <td th:text="${point.p_exp_date}"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(recentPoints)}">
                    <td colspan="6" style="text-align: center;">포인트 내역이 없습니다.</td>
                </tr>
                </tbody>
            </table>
            <br>
            <a th:href="@{/my/point}" class="more-link">더보기 &gt;</a>
        </div>

        <!-- 상품평 -->
        <div class="section">
            <div class="section-header">
                <h3>상품평</h3>
            </div>
            <table class="table-container">
                <thead>
                <tr>
                    <th>번호</th>
                    <th>상품명</th>
                    <th>내용</th>
                    <th>별점</th>
                    <th>작성일</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="review, iterStat : ${#lists.size(recentReviews) > 5 ? recentReviews.subList(0, 5) : recentReviews}">
                    <td th:text="${iterStat.count}"></td>
                    <td th:text="${review.prodName}"></td>
                    <td th:text="${review.rev_content}"></td>
                    <td class="star-rating" th:text="${review.rev_rating}">5</td>
                    <td th:text="${#dates.format(review.rev_rdate, 'yyyy-MM-dd')}"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(recentReviews)}">
                    <td colspan="5" style="text-align: center;">상품평 내역이 없습니다.</td>
                </tr>
                </tbody>
            </table>
            <br>
            <a th:href="@{/my/review}" class="more-link">더보기 &gt;</a>
        </div>

        <!-- 문의 내역 -->
        <div class="section">
            <div class="section-header">
                <h3>나의 문의</h3>
            </div>
            <table class="table-container">
                <thead>
                <tr>
                    <th>번호</th>
                    <th>문의유형</th>
                    <th>문의제목</th>
                    <th>작성일</th>
                    <th>상태</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="qna, iterStat : ${recentQnas}">
                    <td th:text="${iterStat.count}"></td>
                    <td th:text="${qna.q_cate1}"></td>
                    <td th:text="${qna.q_title}"></td>
                    <td th:text="${qna.q_rdate}"></td>
                    <td th:text="${#strings.isEmpty(qna.q_reply)} ? '답변 대기' : '답변 완료'"></td>
                </tr>
                <tr th:if="${#lists.isEmpty(recentQnas)}">
                    <td colspan="5" style="text-align: center;">문의 내역이 없습니다.</td>
                </tr>
                </tbody>
            </table>
            <br>
            <a th:href="@{/my/qna}" class="more-link">더보기 &gt;</a>
        </div>

    </div>
</main>

<div th:replace="~{my/modal.html}"></div>
<div th:replace="~{my/_tail.html}"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        // ===== 주문번호 클릭 시 상세정보 조회 =====
        document.querySelectorAll('.order-number-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const ordNo = this.getAttribute('data-ord-no');
                const itemNo = this.getAttribute('data-item-no');

                fetch(`/shoply/my/order/detail?ord_no=${ordNo}&item_no=${itemNo}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            document.getElementById('orderNo').textContent = data.ordNo || '-';
                            document.getElementById('orderProdName').textContent = data.prodName || '상품명 없음';
                            document.getElementById('orderQty').textContent = data.itemCnt || '-';
                            document.getElementById('orderProdPrice').textContent = (data.prodPrice ? formatPrice(data.prodPrice) : '-');
                            document.getElementById('orderDiscount').textContent = (data.discount ? '-' + formatPrice(data.discount) : '0원');
                            document.getElementById('orderTotalPrice').textContent = (data.totalPrice ? formatPrice(data.totalPrice) : '-');
                            document.getElementById('orderStatus').textContent = getStatusText(data.itemStat);
                            document.getElementById('orderDate').textContent = data.ordDate || '-';

                            if (data.prodImage) {
                                document.getElementById('orderDetailImage').src = '/uploads/' + data.prodImage;
                            }

                            document.getElementById('deliveryName').textContent = data.memName || '-';
                            document.getElementById('deliveryPhone').textContent = data.memHp || '-';
                            const addr = (data.memAddr1 ? '[' + data.memZip + '] ' + data.memAddr1 : '-');
                            document.getElementById('deliveryAddr').textContent = addr + (data.memAddr2 ? ' ' + data.memAddr2 : '');
                            document.getElementById('deliveryMemo').textContent = data.deliveryMemo || '없음';

                            openModal('orderDetailPopup');
                        }
                    })
                    .catch(err => {
                        console.error('주문상세 조회 실패:', err);
                        alert('주문정보를 불러올 수 없습니다.');
                    });
            });
        });

        function formatPrice(price) {
            if (!price) return '0원';
            return parseInt(price).toLocaleString('ko-KR') + '원';
        }

        function getStatusText(stat) {
            const statusMap = {
                1: '배송전', 2: '배송중', 3: '배송완료',
                4: '구매확정', 5: '교환신청', 6: '반품신청'
            };
            return statusMap[stat] || '상태없음';
        }

        // 구매확정 버튼
        document.querySelectorAll('.btn-confirm').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('confirmModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('confirmModal');
                }
            });
        });

        // 리뷰 작성 버튼
        document.querySelectorAll('.btn-review').forEach(btn => {
            btn.addEventListener('click', function() {
                const prodNo = this.getAttribute('data-prod-no');
                const prodName = this.getAttribute('data-prod-name');
                const modal = document.getElementById('reviewModal');
                if(modal) {
                    document.getElementById('review_prod_no').value = prodNo;
                    document.querySelector('.product-name-display').textContent = prodName;
                    openModal('reviewModal');
                }
            });
        });

        // 반품 버튼
        document.querySelectorAll('.btn-return').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('returnModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('returnModal');
                }
            });
        });

        // 교환 버튼
        document.querySelectorAll('.btn-exchange').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('exchangeModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('exchangeModal');
                }
            });
        });

        // 별점 표시
        document.querySelectorAll('.star-rating').forEach(el => {
            const rating = parseInt(el.textContent.trim());
            if (!isNaN(rating)) {
                el.textContent = '★'.repeat(rating);
            }
        });
    });

    function openModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'block';
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'none';
    }
</script>

