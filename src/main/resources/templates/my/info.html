<div th:replace="~{my/_head.html}"></div>

<main class="container">
    <div class="sidebar">
        <h2>나의 쇼핑 정보</h2>
        <ul>
            <li><a th:href="@{/my/home}">마이페이지 홈</a></li>
            <li><a th:href="@{/my/order}">전체주문내역</a></li>
            <li><a th:href="@{/my/point}">포인트내역</a></li>
            <li><a th:href="@{/my/coupon}">쿠폰</a></li>
            <li><a th:href="@{/my/review}">나의리뷰</a></li>
            <li><a th:href="@{/my/qna}">문의하기</a></li>
            <li><a th:href="@{/my/info}" class="active">나의설정</a></li>
        </ul>
    </div>
    <div class="content">
        <div class="main-content-header">
            <div class="info-summary">
                <div class="info-item">
                    <div class="count" th:text="${orderCount}">2</div>
                    <div>주문</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${couponCount}">1</div>
                    <div>쿠폰</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${#numbers.formatInteger(pointTotal, 3, 'COMMA')}">1,000</div>
                    <div>포인트</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${qnaCount}">1</div>
                    <div>문의</div>
                </div>
            </div>
        </div>

        <div class="banner">
            810 x 86 배너 광고
        </div>

        <div class="info-section">
            <h3>나의 설정</h3>
            <form>
                <table class="info-table">
                    <tbody>
                    <tr>
                        <th>사용자 ID</th>
                        <td th:text="${memberInfo.memId}"></td>
                    </tr>
                    <tr>
                        <th>비밀번호</th>
                        <td>
                            <button type="button" onclick="showPasswordModal()">변경</button>
                        </td>
                    </tr>
                    <tr>
                        <th>이름</th>
                        <td th:text="${memberInfo.memName}"></td>
                    </tr>
                    <tr>
                        <th>생년월일</th>
                        <td th:text="${memberInfo.memBirth}"></td>
                    </tr>
                    <tr>
                        <th>Email</th>
                        <td>
                            <input type="text" id="emailId" th:value="${#strings.substringBefore(memberInfo.memEmail, '@')}">@
                            <select id="emailDomain" onchange="checkEmailDomain()">
                                <option th:each="domain : ${{'naver.com', 'gmail.com', 'daum.net', 'self'}}"
                                        th:value="${domain}" th:text="${domain} == 'self' ? '직접입력' : ${domain}"
                                        th:selected="${#strings.substringAfter(memberInfo.memEmail, '@') == domain}">
                                </option>
                            </select>
                            <input type="text" id="emailInput" placeholder="직접입력"
                                   th:style="${#strings.substringAfter(memberInfo.memEmail, '@') == 'self'} ? 'display: inline-block;' : 'display: none;'">
                            <button type="button" onclick="editEmail()">수정하기</button>
                        </td>
                    </tr>
                    <tr>
                        <th>휴대폰</th>
                        <td>
                            <input type="text" th:value="${#strings.arraySplit(memberInfo.memHp, '-')[0]}" style="width: 50px;"> -
                            <input type="text" th:value="${#strings.arraySplit(memberInfo.memHp, '-')[1]}" style="width: 50px;"> -
                            <input type="text" th:value="${#strings.arraySplit(memberInfo.memHp, '-')[2]}" style="width: 50px;">
                            <button type="button" onclick="editPhone()">수정하기</button>
                        </td>
                    </tr>
                    <tr>
                        <th>주소</th>
                        <td>
                            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                                <input type="text" placeholder="우편번호" style="width: 80px;" th:value="${memberInfo.memZip}" readonly>
                                <button type="button" onclick="searchAddress()">주소검색</button>
                            </div>
                            <input type="text" class="address-input" placeholder="기본주소입력" style="width: 400px;" th:value="${memberInfo.memAddr1}" readonly>
                            <input type="text" class="address-input" placeholder="상세주소입력" style="width: 400px; margin-top: 5px;" th:value="${memberInfo.memAddr2}">
                        </td>
                    </tr>
                    </tbody>
                </table>
                <br>
                <td>
                    <button type="button" class="withdrawal-btn" onclick="confirmWithdrawal()">탈퇴하기</button>
                </td>
                <div class="button-group">
                    <button type="submit" class="save-btn" onclick="saveChanges()">수정하기</button>
                </div>
            </form>
        </div>
    </div>
</main>

<div id="passwordModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">현재 비밀번호 확인</h3>
        <div id="currentPasswordSection">
            <input type="password" id="currentPassword" placeholder="현재 비밀번호">
            <div class="message" id="currentPasswordMessage"></div>
            <div class="modal-buttons">
                <button class="confirm-btn" onclick="checkCurrentPassword()">확인</button>
                <button class="cancel-btn" onclick="closePasswordModal()">취소</button>
            </div>
        </div>
        <div id="newPasswordSection" class="hidden">
            <input type="password" id="newPassword" placeholder="새 비밀번호">
            <div class="message" id="newPasswordMessage"></div>
            <input type="password" id="confirmNewPassword" placeholder="새 비밀번호 확인">
            <div class="message" id="confirmNewPasswordMessage"></div>
            <div class="modal-buttons">
                <button class="confirm-btn" onclick="changePassword()">변경</button>
                <button class="cancel-btn" onclick="closePasswordModal()">취소</button>
            </div>
        </div>
    </div>
</div>

<script>
    function checkEmailDomain() {
        const emailSelect = document.getElementById('emailDomain');
        const emailInput = document.getElementById('emailInput');
        if (emailSelect.value === 'self') {
            emailInput.style.display = 'inline-block';
        } else {
            emailInput.style.display = 'none';
        }
    }
    function editEmail() {
        alert('이메일 수정 기능은 현재 개발 중입니다.');
    }
    function editPhone() {
        alert('휴대폰 번호 수정 기능은 현재 개발 중입니다.');
    }
    function saveChanges() {
        alert('수정 사항이 저장되었습니다.');
    }
    function confirmWithdrawal() {
        if (confirm("정말 회원 탈퇴를 하시겠습니까? 탈퇴 시 모든 정보가 삭제되며 복구할 수 없습니다.")) {
            alert("회원 탈퇴가 완료되었습니다.");
            // 실제 서버로 탈퇴 요청을 보내는 로직을 여기에 추가합니다.
        }
    }
    // 로그인 상태 시뮬레이션
    const isLoggedIn = true;
    const loginMenu = document.querySelector('.login-menu');
    const userMenu = document.querySelector('.user-menu');
    if (isLoggedIn) {
        document.body.classList.add('logged-in');
    }
    // 카카오 주소 찾기 API 함수
    function searchAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                let fullAddress = '';
                let extraAddress = '';
                if (data.userSelectedType === 'R') {
                    fullAddress = data.roadAddress;
                } else {
                    fullAddress = data.jibunAddress;
                }
                if (data.userSelectedType === 'R') {
                    if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                        extraAddress += data.bname;
                    }
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraAddress += (extraAddress !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    if (extraAddress !== '') {
                        extraAddress = ' (' + extraAddress + ')';
                    }
                }
                document.querySelector('input[placeholder="우편번호"]').value = data.zonecode;
                document.querySelector('input[placeholder="기본주소입력"]').value = fullAddress + extraAddress;
                document.querySelector('input[placeholder="상세주소입력"]').value = '';
                document.querySelector('input[placeholder="상세주소입력"]').focus();
            }
        }).open();
    }
    /* --- 비밀번호 변경 모달 관련 스크립트 --- */
    const passwordModal = document.getElementById('passwordModal');
    const modalTitle = document.getElementById('modalTitle');
    const currentPasswordSection = document.getElementById('currentPasswordSection');
    const newPasswordSection = document.getElementById('newPasswordSection');
    const currentPasswordInput = document.getElementById('currentPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
    const currentPasswordMessage = document.getElementById('currentPasswordMessage');
    const newPasswordMessage = document.getElementById('newPasswordMessage');
    const confirmNewPasswordMessage = document.getElementById('confirmNewPasswordMessage');
    function showPasswordModal() {
        passwordModal.style.display = 'flex';
        modalTitle.textContent = '현재 비밀번호 확인';
        currentPasswordSection.classList.remove('hidden');
        newPasswordSection.classList.add('hidden');
        // 필드 초기화
        currentPasswordInput.value = '';
        newPasswordInput.value = '';
        confirmNewPasswordInput.value = '';
        currentPasswordMessage.textContent = '';
        newPasswordMessage.textContent = '';
        confirmNewPasswordMessage.textContent = '';
    }
    function closePasswordModal() {
        passwordModal.style.display = 'none';
    }
    function checkCurrentPassword() {
        const currentPassword = currentPasswordInput.value;
        // 실제로는 서버에 현재 비밀번호를 보내서 확인하는 로직이 필요
        // 여기서는 임시로 "1234"라고 가정
        const correctPassword = "1234";
        if (currentPassword === correctPassword) {
            modalTitle.textContent = '새 비밀번호 입력';
            currentPasswordSection.classList.add('hidden');
            newPasswordSection.classList.remove('hidden');
        } else {
            currentPasswordMessage.textContent = '현재 비밀번호가 일치하지 않습니다.';
        }
    }
    function changePassword() {
        const newPassword = newPasswordInput.value;
        const confirmNewPassword = confirmNewPasswordInput.value;
        let isValid = true;
        // 비밀번호 유효성 검사 (예: 8자 이상)
        if (newPassword.length < 8) {
            newPasswordMessage.textContent = '비밀번호는 8자 이상이어야 합니다.';
            isValid = false;
        } else {
            newPasswordMessage.textContent = '';
        }
        // 비밀번호 확인 일치 여부 검사
        if (newPassword !== confirmNewPassword) {
            confirmNewPasswordMessage.textContent = '새 비밀번호가 일치하지 않습니다.';
            isValid = false;
        } else {
            confirmNewPasswordMessage.textContent = '';
        }
        if (isValid) {
            alert('비밀번호가 성공적으로 변경되었습니다!');
            closePasswordModal();
            // 실제로는 서버에 새 비밀번호를 보내서 저장하는 로직이 필요
        }
    }
</script>
<div th:replace="~{my/_tail.html}"></div>