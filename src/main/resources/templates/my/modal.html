<!-- modal.html --><!-- modal.html (통합 버전) -->

<!-- 주문 상세 모달 -->
<div id="orderDetailPopup" class="modal">
    <div class="modal-content" style="width: 700px;">
        <div class="modal-header">
            <h4>주문상세</h4>
            <span class="close-btn" onclick="closeModal('orderDetailPopup')">&times;</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <!-- 주문정보 섹션 -->
            <div class="section-title" style="font-size: 14px; font-weight: 700; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                주문정보
            </div>
            <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                <div style="flex-shrink: 0;">
                    <img id="orderDetailImage" alt="상품 이미지" style="width: 100px; height: 100px; background: #eee; border-radius: 4px; object-fit: cover;">
                </div>
                <div style="flex: 1;">
                    <p style="margin-bottom: 8px; font-size: 13px; color: #666;">주문번호: <span id="orderNo" style="color: #333; font-weight: 500;">-</span></p>
                    <p style="margin-bottom: 8px; font-size: 13px; color: #666;">(주) <a href="#" onclick="openModal('sellerInfoPopup'); closeModal('orderDetailPopup');" style="color: #0066cc; text-decoration: none;">샵플리닷컴</a></p>
                    <p id="orderProdName" style="font-size: 14px; font-weight: 600; color: #333; margin: 8px 0;">-</p>
                    <p style="margin-bottom: 8px; font-size: 13px; color: #666;">수량: <span id="orderQty" style="color: #333; font-weight: 500;">-</span>개</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div style="padding: 12px; background: #f9f9f9; border-radius: 4px; text-align: center;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">상품가격</div>
                            <div id="orderProdPrice" style="font-size: 16px; font-weight: 700; color: #333;">-</div>
                        </div>
                        <div style="padding: 12px; background: #f9f9f9; border-radius: 4px; text-align: center;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">할인/쿠폰</div>
                            <div id="orderDiscount" style="font-size: 16px; font-weight: 700; color: #ff6b6b;">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <table style="width: 100%; font-size: 13px; margin-top: 15px;">
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">결제금액</td>
                    <td style="color: #666; padding-left: 15px; font-size: 15px; font-weight: 700; color: #946ccf;" id="orderTotalPrice">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">배송상태</td>
                    <td style="color: #666; padding-left: 15px;" id="orderStatus">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">주문날짜</td>
                    <td style="color: #666; padding-left: 15px;" id="orderDate">-</td>
                </tr>
            </table>
            <!-- 배송정보 섹션 -->
            <div class="section-title" style="font-size: 14px; font-weight: 700; color: #333; margin-top: 20px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                배송정보
            </div>
            <table style="width: 100%; font-size: 13px;">
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">이름</td>
                    <td style="color: #666; padding-left: 15px;" id="deliveryName">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">연락처</td>
                    <td style="color: #666; padding-left: 15px;" id="deliveryPhone">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">주소</td>
                    <td style="color: #666; padding-left: 15px;" id="deliveryAddr">-</td>
                </tr>
                <tr>
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">배송요청사항</td>
                    <td style="color: #666; padding-left: 15px;" id="deliveryMemo">없음</td>
                </tr>
            </table>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; padding-top: 15px; border-top: 1px solid #ddd;">
                <button onclick="openModal('qnaPopup'); closeModal('orderDetailPopup');" style="padding: 8px 16px; background: #946ccf; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">문의하기</button>
                <button onclick="closeModal('orderDetailPopup')" style="padding: 8px 16px; background: #f0f0f0; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- 판매자 정보 모달 -->
<div id="sellerInfoPopup" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>판매자 정보</h4>
            <span class="close-btn" onclick="closeModal('sellerInfoPopup')">&times;</span>
        </div>
        <table class="info-table">
            <tbody>
            <tr>
                <td class="label" style="width: 150px;">상호</td>
                <td>(주) 샵플리</td>
            </tr>
            <tr>
                <td class="label">대표자</td>
                <td>홍길동</td>
            </tr>
            </tbody>
        </table>
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="openModal('qnaPopup'); closeModal('sellerInfoPopup');">문의하기</button>
        </div>
    </div>
</div>

<!-- 문의하기 모달 -->
<div id="qnaPopup" class="modal">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header">
            <h4>문의하기</h4>
            <span class="close-btn" onclick="closeModal('qnaPopup')">&times;</span>
        </div>
        <form id="qnaForm">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label">문의유형</td>
                    <td>
                        <input type="radio" name="qna_type" value="상품"> 상품
                        <input type="radio" name="qna_type" value="배송"> 배송
                        <input type="radio" name="qna_type" value="기타"> 기타
                    </td>
                </tr>
                <tr>
                    <td class="label">제목</td>
                    <td><input type="text" name="title" style="width: 95%;"></td>
                </tr>
                <tr>
                    <td class="label">내용</td>
                    <td><textarea name="content" style="width: 95%; height: 150px;"></textarea></td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit">등록하기</button>
                <button type="button" onclick="closeModal('qnaPopup')">취소</button>
            </div>
        </form>
    </div>
</div>

<!-- 구매확정 모달 -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="width: 400px; text-align: center;">
        <div class="modal-header">
            <h4>구매확정</h4>
            <span class="close-btn" onclick="closeModal('confirmModal')">&times;</span>
        </div>
        <p>상품을 받으셨나요?</p>
        <p>상품을 받으신 분만 구매확정을 해주세요.</p>
        <div style="margin-top: 20px;">
            <button id="confirmOrderBtn" style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px;">확인</button>
            <button onclick="closeModal('confirmModal')" style="padding: 8px 15px; background-color: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">취소</button>
        </div>
    </div>
</div>

<!-- 리뷰 작성 모달 -->
<div id="reviewModal" class="modal">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header">
            <h4>상품평 작성하기</h4>
            <span class="close-btn" onclick="closeModal('reviewModal')">&times;</span>
        </div>
        <form id="reviewForm">
            <input type="hidden" name="prod_no" id="review_prod_no">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label">상품명</td>
                    <td><p class="product-name-display">상품명</p></td>
                </tr>
                <tr>
                    <td class="label">만족도</td>
                    <td>
                        <div class="rating-container">
                            <input type="radio" name="rating" id="star5" value="5">
                            <label for="star5">★</label>
                            <input type="radio" name="rating" id="star4" value="4">
                            <label for="star4">★</label>
                            <input type="radio" name="rating" id="star3" value="3" checked>
                            <label for="star3">★</label>
                            <input type="radio" name="rating" id="star2" value="2">
                            <label for="star2">★</label>
                            <input type="radio" name="rating" id="star1" value="1">
                            <label for="star1">★</label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="label">내용</td>
                    <td>
                        <textarea name="content" id="review_content" style="width: 95%; height: 100px;" placeholder="최소 10자 이상"></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="label">사진</td>
                    <td>
                        <input type="file" name="file1" accept="image/*"><br>
                        <input type="file" name="file2" accept="image/*"><br>
                        <input type="file" name="file3" accept="image/*">
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit">작성완료</button>
                <button type="button" onclick="closeModal('reviewModal')">취소</button>
            </div>
        </form>
    </div>
</div>

<!-- 반품 모달 -->
<div id="returnModal" class="modal">
    <div class="modal-content" style="width: 600px;">
        <div class="modal-header">
            <h4>반품신청</h4>
            <span class="close-btn" onclick="closeModal('returnModal')">&times;</span>
        </div>
        <form id="returnForm">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label" style="width: 120px;">반품 사유</td>
                    <td>
                        <select name="reason" style="width: 95%; padding: 8px;">
                            <option value="">선택하세요</option>
                            <option value="단순변심">단순변심</option>
                            <option value="상품불량">상품불량</option>
                            <option value="배송지연">배송지연</option>
                            <option value="상품정보불일치">상품정보불일치</option>
                            <option value="기타">기타</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="label">상세 내용</td>
                    <td>
                        <textarea name="detail" style="width: 95%; height: 100px;" placeholder="반품 사유를 자세히 입력해주세요"></textarea>
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit" style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px;">신청하기</button>
                <button type="button" onclick="closeModal('returnModal')" style="padding: 8px 15px; background-color: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">취소</button>
            </div>
        </form>
    </div>
</div>

<!-- 교환 모달 -->
<div id="exchangeModal" class="modal">
    <div class="modal-content" style="width: 600px;">
        <div class="modal-header">
            <h4>교환신청</h4>
            <span class="close-btn" onclick="closeModal('exchangeModal')">&times;</span>
        </div>
        <form id="exchangeForm">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label" style="width: 120px;">교환 사유</td>
                    <td>
                        <select name="reason" style="width: 95%; padding: 8px;">
                            <option value="">선택하세요</option>
                            <option value="사이즈/색상 변경">사이즈/색상 변경</option>
                            <option value="상품불량">상품불량</option>
                            <option value="오배송">오배송</option>
                            <option value="상품정보불일치">상품정보불일치</option>
                            <option value="기타">기타</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="label">상세 내용</td>
                    <td>
                        <textarea name="detail" style="width: 95%; height: 100px;" placeholder="교환 사유를 자세히 입력해주세요"></textarea>
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit" style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px;">신청하기</button>
                <button type="button" onclick="closeModal('exchangeModal')" style="padding: 8px 15px; background-color: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">취소</button>
            </div>
        </form>
    </div>
</div>

<!-- 비밀번호 변경 모달 -->
<div id="passwordModal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header">
            <h4>비밀번호 변경</h4>
            <span class="close-btn" onclick="closeModal('passwordModal')">&times;</span>
        </div>
        <form id="passwordForm">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label" style="width: 120px;">현재 비밀번호</td>
                    <td>
                        <input type="password" id="currentPassword" style="width: 95%; padding: 8px;">
                    </td>
                </tr>
                <tr>
                    <td class="label">새 비밀번호</td>
                    <td>
                        <input type="password" id="newPassword" style="width: 95%; padding: 8px;">
                    </td>
                </tr>
                <tr>
                    <td class="label">비밀번호 확인</td>
                    <td>
                        <input type="password" id="confirmPassword" style="width: 95%; padding: 8px;">
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit" style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px;">변경하기</button>
                <button type="button" onclick="closeModal('passwordModal')" style="padding: 8px 15px; background-color: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">취소</button>
            </div>
        </form>
    </div>
</div>
<div id="reviewDetailModal" class="modal">
    <div class="modal-content" style="width: 600px;">
        <div class="modal-header">
            <h4>작성한 리뷰</h4>
            <span class="close-btn" onclick="closeModal('reviewDetailModal')">&times;</span>
        </div>
        <div class="modal-body">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label" style="width: 120px;">상품명</td>
                    <td id="reviewDetailTitle">-</td>
                </tr>
                <tr>
                    <td class="label">별점</td>
                    <td id="reviewDetailRating" style="color: #FFD700; font-size: 18px; font-weight: bold;">★★★★★</td>
                </tr>
                <tr>
                    <td class="label">작성일</td>
                    <td id="reviewDetailDate">-</td>
                </tr>
                <tr>
                    <td class="label">내용</td>
                    <td id="reviewDetailContent" style="line-height: 1.6; word-break: break-word; white-space: pre-wrap;">-</td>
                </tr>
                <tr>
                    <td class="label">사진</td>
                    <td id="reviewDetailImages" style="text-align: center; padding: 10px;">
                        <span style="color: #999;">(이미지 없음)</span>
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeModal('reviewDetailModal')"
                        style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">닫기</button>
            </div>
        </div>
    </div>
</div>
<script>
    // ===== 유틸리티 함수 =====
    function formatPrice(price) {
        if (!price) return '0원';
        return parseInt(price).toLocaleString('ko-KR') + '원';
    }

    function getStatusText(stat) {
        const statusMap = {
            0: '결제완료', 1: '배송준비', 2: '배송중',
            3: '배송완료', 4: '구매확정', 5: '교환신청', 6: '반품신청'
        };
        return statusMap[stat] || '상태없음';
    }

    function openModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'block';
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'none';
    }

    // ===== 모든 이벤트를 하나의 DOMContentLoaded로 통합 =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Modal DOMContentLoaded 시작');

        // 1. 주문번호 클릭 시 상세정보 조회
        document.querySelectorAll('.order-number-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const ordNo = this.getAttribute('data-ord-no');
                const itemNo = this.getAttribute('data-item-no');

                fetch(`/shoply/my/order/detail?ord_no=${ordNo}&item_no=${itemNo}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            document.getElementById('orderNo').textContent = data.ordNo || '-';
                            document.getElementById('orderProdName').textContent = data.prodName || '상품명 없음';
                            document.getElementById('orderQty').textContent = data.itemCnt || '-';
                            document.getElementById('orderProdPrice').textContent = (data.prodPrice ? formatPrice(data.prodPrice) : '-');
                            document.getElementById('orderDiscount').textContent = (data.discount ? '-' + formatPrice(data.discount) : '0원');
                            document.getElementById('orderTotalPrice').textContent = (data.totalPrice ? formatPrice(data.totalPrice) : '-');
                            document.getElementById('orderStatus').textContent = getStatusText(data.itemStat);
                            document.getElementById('orderDate').textContent = data.ordDate || '-';

                            if (data.prodImage) {
                                document.getElementById('orderDetailImage').src = data.prodImage;
                            }

                            document.getElementById('deliveryName').textContent = data.memName || '-';
                            document.getElementById('deliveryPhone').textContent = data.memHp || '-';
                            const addr = (data.memAddr1 ? '[' + data.memZip + '] ' + data.memAddr1 : '-');
                            document.getElementById('deliveryAddr').textContent = addr + (data.memAddr2 ? ' ' + data.memAddr2 : '');
                            document.getElementById('deliveryMemo').textContent = data.deliveryMemo || '없음';

                            openModal('orderDetailPopup');
                        }
                    })
                    .catch(err => {
                        console.error('주문상세 조회 실패:', err);
                        alert('주문정보를 불러올 수 없습니다.');
                    });
            });
        });

        // 2. 구매확정 버튼 (페이지의 .btn-confirm)
        document.querySelectorAll('.btn-confirm').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('confirmModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('confirmModal');
                }
            });
        });

        // 3. 모달 내부의 구매확정 확인 버튼 ✅ 이게 핵심!
        const confirmOrderBtn = document.getElementById('confirmOrderBtn');
        if (confirmOrderBtn) {
            confirmOrderBtn.addEventListener('click', function() {
                const modal = document.getElementById('confirmModal');
                const itemNo = modal.dataset.itemNo;

                fetch(`/shoply/my/order/confirm?item_no=${itemNo}`, {
                    method: 'POST'
                })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('구매확정이 완료되었습니다.');
                            closeModal('confirmModal');
                            location.reload();
                        } else {
                            alert('구매확정 실패: ' + data);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('오류가 발생했습니다.');
                    });
            });
        } else {
            console.error('❌ confirmOrderBtn을 찾을 수 없습니다!');
        }

        // 4. 리뷰 작성 버튼
        document.querySelectorAll('.btn-review').forEach(btn => {
            btn.addEventListener('click', function() {
                const prodNo = this.getAttribute('data-prod-no');
                const prodName = this.getAttribute('data-prod-name');
                const prodNameDisplay = document.querySelector('.product-name-display');
                if(prodNameDisplay) {
                    prodNameDisplay.textContent = prodName;
                }
                document.getElementById('review_prod_no').value = prodNo;
                openModal('reviewModal');
            });
        });

        // 5. 리뷰 작성 폼 제출 ✅ 이것도 핵심!
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const prodNo = document.getElementById('review_prod_no').value;
                const rating = document.querySelector('input[name="rating"]:checked')?.value || 3;
                const content = document.getElementById('review_content').value.trim();

                if (content.length < 10) {
                    alert('리뷰 내용은 최소 10자 이상이어야 합니다.');
                    return;
                }

                const formData = new FormData();
                formData.append('prod_no', prodNo);
                formData.append('rating', rating);
                formData.append('content', content);
                formData.append('file1', document.querySelector('input[name="file1"]').files[0] || '');
                formData.append('file2', document.querySelector('input[name="file2"]').files[0] || '');
                formData.append('file3', document.querySelector('input[name="file3"]').files[0] || '');

                fetch('/shoply/my/review/write', {
                    method: 'POST',
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert('리뷰가 작성되었습니다.');
                            closeModal('reviewModal');
                            reviewForm.reset();
                            location.reload();
                        } else {
                            alert('리뷰 작성 실패: ' + data.message);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('오류가 발생했습니다.');
                    });
            });
        } else {
            console.error('❌ reviewForm을 찾을 수 없습니다!');
        }

        // 6. 반품 버튼
        document.querySelectorAll('.btn-return').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('returnModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('returnModal');
                }
            });
        });

        // 7. 반품 신청 폼
        const returnForm = document.getElementById('returnForm');
        if (returnForm) {
            returnForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const modal = document.getElementById('returnModal');
                const itemNo = modal.dataset.itemNo;
                const reason = returnForm.querySelector('select[name="reason"]').value;
                const detail = returnForm.querySelector('textarea[name="detail"]').value.trim();

                if (!reason) {
                    alert('반품 사유를 선택해주세요.');
                    return;
                }
                if (!detail) {
                    alert('상세 내용을 입력해주세요.');
                    return;
                }

                const fullReason = reason + (detail ? ' - ' + detail : '');

                fetch(`/shoply/my/order/return?item_no=${itemNo}&reason=${encodeURIComponent(fullReason)}`, {
                    method: 'POST'
                })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('반품 신청이 완료되었습니다.');
                            closeModal('returnModal');
                            returnForm.reset();
                            location.reload();
                        } else {
                            alert('반품 신청 실패: ' + data);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('오류가 발생했습니다.');
                    });
            });
        }

        // 8. 교환 버튼
        document.querySelectorAll('.btn-exchange').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('exchangeModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('exchangeModal');
                }
            });
        });

        // 9. 교환 신청 폼
        const exchangeForm = document.getElementById('exchangeForm');
        if (exchangeForm) {
            exchangeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const modal = document.getElementById('exchangeModal');
                const itemNo = modal.dataset.itemNo;
                const reason = exchangeForm.querySelector('select[name="reason"]').value;
                const detail = exchangeForm.querySelector('textarea[name="detail"]').value.trim();

                if (!reason) {
                    alert('교환 사유를 선택해주세요.');
                    return;
                }
                if (!detail) {
                    alert('상세 내용을 입력해주세요.');
                    return;
                }

                const fullReason = reason + (detail ? ' - ' + detail : '');

                fetch(`/shoply/my/order/exchange?item_no=${itemNo}&reason=${encodeURIComponent(fullReason)}`, {
                    method: 'POST'
                })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('교환 신청이 완료되었습니다.');
                            closeModal('exchangeModal');
                            exchangeForm.reset();
                            location.reload();
                        } else {
                            alert('교환 신청 실패: ' + data);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('오류가 발생했습니다.');
                    });
            });
        }

        // 10. 비밀번호 변경 폼
        const passwordForm = document.getElementById('passwordForm');
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value.trim();
                const newPassword = document.getElementById('newPassword').value.trim();
                const confirmPassword = document.getElementById('confirmPassword').value.trim();

                if (!currentPassword) {
                    alert('현재 비밀번호를 입력해주세요.');
                    return;
                }
                if (!newPassword) {
                    alert('새 비밀번호를 입력해주세요.');
                    return;
                }
                if (newPassword.length < 6) {
                    alert('비밀번호는 최소 6자 이상이어야 합니다.');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('비밀번호가 일치하지 않습니다.');
                    return;
                }

                fetch('/shoply/my/info/changePassword', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('비밀번호가 변경되었습니다.');
                            closeModal('passwordModal');
                            passwordForm.reset();
                        } else {
                            alert('비밀번호 변경 실패: ' + data);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('오류가 발생했습니다.');
                    });
            });
        }

        // 11. 별점 표시
        document.querySelectorAll('.star-rating').forEach(el => {
            const rating = parseInt(el.textContent.trim());
            if (!isNaN(rating)) {
                el.textContent = '★'.repeat(rating);
            }
        });

        // 12. 작성한 리뷰 보기 버튼
        document.querySelectorAll('.btn-view-review').forEach(btn => {
            btn.addEventListener('click', function() {
                const prodNo = this.getAttribute('data-prod-no');
                const prodName = this.getAttribute('data-prod-name');

                console.log('리뷰 조회 시작:', prodNo, prodName);

                fetch(`/shoply/my/review/detail?prod_no=${prodNo}`)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP 오류: ${res.status}`);
                        return res.json();
                    })
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }

                        if (data && data.rev_rating !== undefined) {
                            const titleEl = document.getElementById('reviewDetailTitle');
                            const ratingEl = document.getElementById('reviewDetailRating');
                            const contentEl = document.getElementById('reviewDetailContent');
                            const dateEl = document.getElementById('reviewDetailDate');
                            const imageEl = document.getElementById('reviewDetailImages');

                            if (!titleEl || !ratingEl || !contentEl || !dateEl || !imageEl) {
                                console.error('모달 요소를 찾을 수 없습니다.');
                                alert('모달을 불러올 수 없습니다. 페이지를 새로고침해주세요.');
                                return;
                            }

                            titleEl.textContent = prodName || '상품명 없음';
                            ratingEl.textContent = '★'.repeat(data.rev_rating || 0);
                            contentEl.textContent = data.rev_content || '-';

                            if (data.rev_rdate) {
                                let dateStr = data.rev_rdate;
                                if (dateStr.includes('T')) {
                                    dateStr = dateStr.split('T')[0];
                                }
                                dateEl.textContent = dateStr;
                            } else {
                                dateEl.textContent = '-';
                            }

                            imageEl.innerHTML = '';

                            if (data.rev_files && Array.isArray(data.rev_files) && data.rev_files.length > 0) {
                                data.rev_files.forEach((file, index) => {
                                    let imagePath = file.trim();

                                    if (!imagePath.startsWith('/')) {
                                        imagePath = `/uploads/review/${imagePath}`;
                                    } else if (!imagePath.startsWith('/uploads/')) {
                                        imagePath = `/uploads/review/${imagePath}`;
                                    }

                                    const img = document.createElement('img');
                                    img.src = imagePath;
                                    img.alt = `리뷰 이미지 ${index + 1}`;
                                    img.style.cssText = 'width: 150px; height: 150px; margin: 5px; border-radius: 4px; object-fit: cover; cursor: pointer; border: 1px solid #ddd;';

                                    img.onerror = function() {
                                        this.style.border = '2px solid #ff6b6b';
                                        this.title = '이미지 로드 실패: ' + imagePath;
                                    };

                                    img.onclick = function() {
                                        window.open(this.src, '_blank');
                                    };

                                    imageEl.appendChild(img);
                                });
                            } else {
                                imageEl.innerHTML = '<span style="color: #999; display: inline-block; padding: 20px;">(이미지 없음)</span>';
                            }

                            openModal('reviewDetailModal');
                        }
                    })
                    .catch(err => {
                        console.error('리뷰 조회 실패:', err);
                        alert('리뷰 조회 실패: ' + err.message);
                    });
            });
        });

        // 13. 판매자 정보 팝업의 문의하기 버튼
        const sellerModal = document.getElementById('sellerInfoPopup');
        if (sellerModal) {
            const inquiryBtn = sellerModal.querySelector('button');
            if (inquiryBtn) {
                inquiryBtn.addEventListener('click', function() {
                    openModal('qnaPopup');
                    closeModal('sellerInfoPopup');
                });
            }
        }

        console.log('Modal DOMContentLoaded 완료');
    });

    // ===== 판매자 정보 조회 (외부 함수) =====
    function openSellerInfo(memId) {
        fetch(`/shoply/my/seller/info?mem_id=${memId}`)
            .then(res => res.json())
            .then(data => {
                if (data) {
                    const gradeStyles = {
                        'DIAMOND': { color: '#00D4FF', badge: '💎 DIAMOND' },
                        'GOLD': { color: '#FFD700', badge: '⭐ GOLD' },
                        'SILVER': { color: '#C0C0C0', badge: '✨ SILVER' },
                        'BRONZE': { color: '#CD7F32', badge: '🔶 BRONZE' }
                    };

                    const gradeInfo = gradeStyles[data.sellerGrade] || gradeStyles['BRONZE'];
                    const sellerModal = document.querySelector('#sellerInfoPopup .info-table tbody');

                    sellerModal.innerHTML = `
                        <tr>
                            <td class="label" style="width: 150px;">판매자 등급</td>
                            <td style="color: ${gradeInfo.color}; font-weight: bold;">${gradeInfo.badge}</td>
                        </tr>
                        <tr>
                            <td class="label">상호</td>
                            <td>${data.corpName || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">대표자</td>
                            <td>${data.memName || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">전화번호</td>
                            <td>${data.corpTelHp || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">FAX</td>
                            <td>${data.corpFax || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">사업자번호</td>
                            <td>${data.corpRegHp || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">영업소재지</td>
                            <td>[${data.memZip}] ${data.memAddr1} ${data.memAddr2 || ''}</td>
                        </tr>
                        <tr>
                            <td class="label">누적 판매액</td>
                            <td>${Number(data.totSellPrice).toLocaleString('ko-KR')}원</td>
                        </tr>
                    `;

                    openModal('sellerInfoPopup');
                }
            })
            .catch(err => {
                console.error('판매자 정보 조회 실패:', err);
                alert('판매자 정보를 불러올 수 없습니다.');
            });
    }
</script>
