<!-- modal.html --><!-- modal.html (í†µí•© ë²„ì „) -->

<!-- ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
<div id="orderDetailPopup" class="modal">
    <div class="modal-content" style="width: 700px;">
        <div class="modal-header">
            <h4>ì£¼ë¬¸ìƒì„¸</h4>
            <span class="close-btn" onclick="closeModal('orderDetailPopup')">&times;</span>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <!-- ì£¼ë¬¸ì •ë³´ ì„¹ì…˜ -->
            <div class="section-title" style="font-size: 14px; font-weight: 700; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                ì£¼ë¬¸ì •ë³´
            </div>
            <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                <div style="flex-shrink: 0;">
                    <img id="orderDetailImage" alt="ìƒí’ˆ ì´ë¯¸ì§€" style="width: 100px; height: 100px; background: #eee; border-radius: 4px; object-fit: cover;">
                </div>
                <div style="flex: 1;">
                    <p style="margin-bottom: 8px; font-size: 13px; color: #666;">ì£¼ë¬¸ë²ˆí˜¸: <span id="orderNo" style="color: #333; font-weight: 500;">-</span></p>
                    <p style="margin-bottom: 8px; font-size: 13px; color: #666;">(ì£¼) <a href="#" onclick="openModal('sellerInfoPopup'); closeModal('orderDetailPopup');" style="color: #0066cc; text-decoration: none;">ìƒµí”Œë¦¬ë‹·ì»´</a></p>
                    <p id="orderProdName" style="font-size: 14px; font-weight: 600; color: #333; margin: 8px 0;">-</p>
                    <p style="margin-bottom: 8px; font-size: 13px; color: #666;">ìˆ˜ëŸ‰: <span id="orderQty" style="color: #333; font-weight: 500;">-</span>ê°œ</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div style="padding: 12px; background: #f9f9f9; border-radius: 4px; text-align: center;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ìƒí’ˆê°€ê²©</div>
                            <div id="orderProdPrice" style="font-size: 16px; font-weight: 700; color: #333;">-</div>
                        </div>
                        <div style="padding: 12px; background: #f9f9f9; border-radius: 4px; text-align: center;">
                            <div style="font-size: 12px; color: #999; margin-bottom: 5px;">í• ì¸/ì¿ í°</div>
                            <div id="orderDiscount" style="font-size: 16px; font-weight: 700; color: #ff6b6b;">-</div>
                        </div>
                    </div>
                </div>
            </div>
            <table style="width: 100%; font-size: 13px; margin-top: 15px;">
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">ê²°ì œê¸ˆì•¡</td>
                    <td style="color: #666; padding-left: 15px; font-size: 15px; font-weight: 700; color: #946ccf;" id="orderTotalPrice">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">ë°°ì†¡ìƒíƒœ</td>
                    <td style="color: #666; padding-left: 15px;" id="orderStatus">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">ì£¼ë¬¸ë‚ ì§œ</td>
                    <td style="color: #666; padding-left: 15px;" id="orderDate">-</td>
                </tr>
            </table>
            <!-- ë°°ì†¡ì •ë³´ ì„¹ì…˜ -->
            <div class="section-title" style="font-size: 14px; font-weight: 700; color: #333; margin-top: 20px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
                ë°°ì†¡ì •ë³´
            </div>
            <table style="width: 100%; font-size: 13px;">
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">ì´ë¦„</td>
                    <td style="color: #666; padding-left: 15px;" id="deliveryName">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">ì—°ë½ì²˜</td>
                    <td style="color: #666; padding-left: 15px;" id="deliveryPhone">-</td>
                </tr>
                <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">ì£¼ì†Œ</td>
                    <td style="color: #666; padding-left: 15px;" id="deliveryAddr">-</td>
                </tr>
                <tr>
                    <td style="padding: 10px 0; width: 120px; font-weight: 500; color: #333; background: #fafafa; padding-left: 10px;">ë°°ì†¡ìš”ì²­ì‚¬í•­</td>
                    <td style="color: #666; padding-left: 15px;" id="deliveryMemo">ì—†ìŒ</td>
                </tr>
            </table>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; padding-top: 15px; border-top: 1px solid #ddd;">
                <button onclick="openModal('qnaPopup'); closeModal('orderDetailPopup');" style="padding: 8px 16px; background: #946ccf; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">ë¬¸ì˜í•˜ê¸°</button>
                <button onclick="closeModal('orderDetailPopup')" style="padding: 8px 16px; background: #f0f0f0; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 500;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>

<!-- íŒë§¤ì ì •ë³´ ëª¨ë‹¬ -->
<div id="sellerInfoPopup" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h4>íŒë§¤ì ì •ë³´</h4>
            <span class="close-btn" onclick="closeModal('sellerInfoPopup')">&times;</span>
        </div>
        <table class="info-table">
            <tbody>
            <tr>
                <td class="label" style="width: 150px;">ìƒí˜¸</td>
                <td>(ì£¼) ìƒµí”Œë¦¬</td>
            </tr>
            <tr>
                <td class="label">ëŒ€í‘œì</td>
                <td>í™ê¸¸ë™</td>
            </tr>
            </tbody>
        </table>
        <div style="text-align: right; margin-top: 20px;">
            <button onclick="openModal('qnaPopup'); closeModal('sellerInfoPopup');">ë¬¸ì˜í•˜ê¸°</button>
        </div>
    </div>
</div>

<!-- ë¬¸ì˜í•˜ê¸° ëª¨ë‹¬ -->
<div id="qnaPopup" class="modal">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header">
            <h4>ë¬¸ì˜í•˜ê¸°</h4>
            <span class="close-btn" onclick="closeModal('qnaPopup')">&times;</span>
        </div>
        <form id="qnaForm">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label">ë¬¸ì˜ìœ í˜•</td>
                    <td>
                        <input type="radio" name="qna_type" value="ìƒí’ˆ"> ìƒí’ˆ
                        <input type="radio" name="qna_type" value="ë°°ì†¡"> ë°°ì†¡
                        <input type="radio" name="qna_type" value="ê¸°íƒ€"> ê¸°íƒ€
                    </td>
                </tr>
                <tr>
                    <td class="label">ì œëª©</td>
                    <td><input type="text" name="title" style="width: 95%;"></td>
                </tr>
                <tr>
                    <td class="label">ë‚´ìš©</td>
                    <td><textarea name="content" style="width: 95%; height: 150px;"></textarea></td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit">ë“±ë¡í•˜ê¸°</button>
                <button type="button" onclick="closeModal('qnaPopup')">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- êµ¬ë§¤í™•ì • ëª¨ë‹¬ -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="width: 400px; text-align: center;">
        <div class="modal-header">
            <h4>êµ¬ë§¤í™•ì •</h4>
            <span class="close-btn" onclick="closeModal('confirmModal')">&times;</span>
        </div>
        <p>ìƒí’ˆì„ ë°›ìœ¼ì…¨ë‚˜ìš”?</p>
        <p>ìƒí’ˆì„ ë°›ìœ¼ì‹  ë¶„ë§Œ êµ¬ë§¤í™•ì •ì„ í•´ì£¼ì„¸ìš”.</p>
        <div style="margin-top: 20px;">
            <button id="confirmOrderBtn" style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px;">í™•ì¸</button>
            <button onclick="closeModal('confirmModal')" style="padding: 8px 15px; background-color: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<!-- ë¦¬ë·° ì‘ì„± ëª¨ë‹¬ -->
<div id="reviewModal" class="modal">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header">
            <h4>ìƒí’ˆí‰ ì‘ì„±í•˜ê¸°</h4>
            <span class="close-btn" onclick="closeModal('reviewModal')">&times;</span>
        </div>
        <form id="reviewForm">
            <input type="hidden" name="prod_no" id="review_prod_no">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label">ìƒí’ˆëª…</td>
                    <td><p class="product-name-display">ìƒí’ˆëª…</p></td>
                </tr>
                <tr>
                    <td class="label">ë§Œì¡±ë„</td>
                    <td>
                        <div class="rating-container">
                            <input type="radio" name="rating" id="star5" value="5">
                            <label for="star5">â˜…</label>
                            <input type="radio" name="rating" id="star4" value="4">
                            <label for="star4">â˜…</label>
                            <input type="radio" name="rating" id="star3" value="3" checked>
                            <label for="star3">â˜…</label>
                            <input type="radio" name="rating" id="star2" value="2">
                            <label for="star2">â˜…</label>
                            <input type="radio" name="rating" id="star1" value="1">
                            <label for="star1">â˜…</label>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="label">ë‚´ìš©</td>
                    <td>
                        <textarea name="content" id="review_content" style="width: 95%; height: 100px;" placeholder="ìµœì†Œ 10ì ì´ìƒ"></textarea>
                    </td>
                </tr>
                <tr>
                    <td class="label">ì‚¬ì§„</td>
                    <td>
                        <input type="file" name="file1" accept="image/*"><br>
                        <input type="file" name="file2" accept="image/*"><br>
                        <input type="file" name="file3" accept="image/*">
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit">ì‘ì„±ì™„ë£Œ</button>
                <button type="button" onclick="closeModal('reviewModal')">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- ë°˜í’ˆ ëª¨ë‹¬ -->
<div id="returnModal" class="modal">
    <div class="modal-content" style="width: 600px;">
        <div class="modal-header">
            <h4>ë°˜í’ˆì‹ ì²­</h4>
            <span class="close-btn" onclick="closeModal('returnModal')">&times;</span>
        </div>
        <form id="returnForm">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label" style="width: 120px;">ë°˜í’ˆ ì‚¬ìœ </td>
                    <td>
                        <select name="reason" style="width: 95%; padding: 8px;">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ë‹¨ìˆœë³€ì‹¬">ë‹¨ìˆœë³€ì‹¬</option>
                            <option value="ìƒí’ˆë¶ˆëŸ‰">ìƒí’ˆë¶ˆëŸ‰</option>
                            <option value="ë°°ì†¡ì§€ì—°">ë°°ì†¡ì§€ì—°</option>
                            <option value="ìƒí’ˆì •ë³´ë¶ˆì¼ì¹˜">ìƒí’ˆì •ë³´ë¶ˆì¼ì¹˜</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="label">ìƒì„¸ ë‚´ìš©</td>
                    <td>
                        <textarea name="detail" style="width: 95%; height: 100px;" placeholder="ë°˜í’ˆ ì‚¬ìœ ë¥¼ ìì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit" style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px;">ì‹ ì²­í•˜ê¸°</button>
                <button type="button" onclick="closeModal('returnModal')" style="padding: 8px 15px; background-color: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- êµí™˜ ëª¨ë‹¬ -->
<div id="exchangeModal" class="modal">
    <div class="modal-content" style="width: 600px;">
        <div class="modal-header">
            <h4>êµí™˜ì‹ ì²­</h4>
            <span class="close-btn" onclick="closeModal('exchangeModal')">&times;</span>
        </div>
        <form id="exchangeForm">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label" style="width: 120px;">êµí™˜ ì‚¬ìœ </td>
                    <td>
                        <select name="reason" style="width: 95%; padding: 8px;">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì‚¬ì´ì¦ˆ/ìƒ‰ìƒ ë³€ê²½">ì‚¬ì´ì¦ˆ/ìƒ‰ìƒ ë³€ê²½</option>
                            <option value="ìƒí’ˆë¶ˆëŸ‰">ìƒí’ˆë¶ˆëŸ‰</option>
                            <option value="ì˜¤ë°°ì†¡">ì˜¤ë°°ì†¡</option>
                            <option value="ìƒí’ˆì •ë³´ë¶ˆì¼ì¹˜">ìƒí’ˆì •ë³´ë¶ˆì¼ì¹˜</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="label">ìƒì„¸ ë‚´ìš©</td>
                    <td>
                        <textarea name="detail" style="width: 95%; height: 100px;" placeholder="êµí™˜ ì‚¬ìœ ë¥¼ ìì„¸íˆ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit" style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px;">ì‹ ì²­í•˜ê¸°</button>
                <button type="button" onclick="closeModal('exchangeModal')" style="padding: 8px 15px; background-color: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
<div id="passwordModal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header">
            <h4>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
            <span class="close-btn" onclick="closeModal('passwordModal')">&times;</span>
        </div>
        <form id="passwordForm">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label" style="width: 120px;">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</td>
                    <td>
                        <input type="password" id="currentPassword" style="width: 95%; padding: 8px;">
                    </td>
                </tr>
                <tr>
                    <td class="label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</td>
                    <td>
                        <input type="password" id="newPassword" style="width: 95%; padding: 8px;">
                    </td>
                </tr>
                <tr>
                    <td class="label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</td>
                    <td>
                        <input type="password" id="confirmPassword" style="width: 95%; padding: 8px;">
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit" style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 5px;">ë³€ê²½í•˜ê¸°</button>
                <button type="button" onclick="closeModal('passwordModal')" style="padding: 8px 15px; background-color: #ccc; color: #333; border: none; border-radius: 5px; cursor: pointer;">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>
<div id="reviewDetailModal" class="modal">
    <div class="modal-content" style="width: 600px;">
        <div class="modal-header">
            <h4>ì‘ì„±í•œ ë¦¬ë·°</h4>
            <span class="close-btn" onclick="closeModal('reviewDetailModal')">&times;</span>
        </div>
        <div class="modal-body">
            <table class="info-table">
                <tbody>
                <tr>
                    <td class="label" style="width: 120px;">ìƒí’ˆëª…</td>
                    <td id="reviewDetailTitle">-</td>
                </tr>
                <tr>
                    <td class="label">ë³„ì </td>
                    <td id="reviewDetailRating" style="color: #FFD700; font-size: 18px; font-weight: bold;">â˜…â˜…â˜…â˜…â˜…</td>
                </tr>
                <tr>
                    <td class="label">ì‘ì„±ì¼</td>
                    <td id="reviewDetailDate">-</td>
                </tr>
                <tr>
                    <td class="label">ë‚´ìš©</td>
                    <td id="reviewDetailContent" style="line-height: 1.6; word-break: break-word; white-space: pre-wrap;">-</td>
                </tr>
                <tr>
                    <td class="label">ì‚¬ì§„</td>
                    <td id="reviewDetailImages" style="text-align: center; padding: 10px;">
                        <span style="color: #999;">(ì´ë¯¸ì§€ ì—†ìŒ)</span>
                    </td>
                </tr>
                </tbody>
            </table>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeModal('reviewDetailModal')"
                        style="padding: 8px 15px; background-color: #946ccf; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</div>
<script>
    // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
    function formatPrice(price) {
        if (!price) return '0ì›';
        return parseInt(price).toLocaleString('ko-KR') + 'ì›';
    }

    function getStatusText(stat) {
        const statusMap = {
            0: 'ê²°ì œì™„ë£Œ', 1: 'ë°°ì†¡ì¤€ë¹„', 2: 'ë°°ì†¡ì¤‘',
            3: 'ë°°ì†¡ì™„ë£Œ', 4: 'êµ¬ë§¤í™•ì •', 5: 'êµí™˜ì‹ ì²­', 6: 'ë°˜í’ˆì‹ ì²­'
        };
        return statusMap[stat] || 'ìƒíƒœì—†ìŒ';
    }

    function openModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'block';
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'none';
    }

    // ===== ëª¨ë“  ì´ë²¤íŠ¸ë¥¼ í•˜ë‚˜ì˜ DOMContentLoadedë¡œ í†µí•© =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Modal DOMContentLoaded ì‹œì‘');

        // 1. ì£¼ë¬¸ë²ˆí˜¸ í´ë¦­ ì‹œ ìƒì„¸ì •ë³´ ì¡°íšŒ
        document.querySelectorAll('.order-number-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const ordNo = this.getAttribute('data-ord-no');
                const itemNo = this.getAttribute('data-item-no');

                fetch(`/shoply/my/order/detail?ord_no=${ordNo}&item_no=${itemNo}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            document.getElementById('orderNo').textContent = data.ordNo || '-';
                            document.getElementById('orderProdName').textContent = data.prodName || 'ìƒí’ˆëª… ì—†ìŒ';
                            document.getElementById('orderQty').textContent = data.itemCnt || '-';
                            document.getElementById('orderProdPrice').textContent = (data.prodPrice ? formatPrice(data.prodPrice) : '-');
                            document.getElementById('orderDiscount').textContent = (data.discount ? '-' + formatPrice(data.discount) : '0ì›');
                            document.getElementById('orderTotalPrice').textContent = (data.totalPrice ? formatPrice(data.totalPrice) : '-');
                            document.getElementById('orderStatus').textContent = getStatusText(data.itemStat);
                            document.getElementById('orderDate').textContent = data.ordDate || '-';

                            if (data.prodImage) {
                                document.getElementById('orderDetailImage').src = data.prodImage;
                            }

                            document.getElementById('deliveryName').textContent = data.memName || '-';
                            document.getElementById('deliveryPhone').textContent = data.memHp || '-';
                            const addr = (data.memAddr1 ? '[' + data.memZip + '] ' + data.memAddr1 : '-');
                            document.getElementById('deliveryAddr').textContent = addr + (data.memAddr2 ? ' ' + data.memAddr2 : '');
                            document.getElementById('deliveryMemo').textContent = data.deliveryMemo || 'ì—†ìŒ';

                            openModal('orderDetailPopup');
                        }
                    })
                    .catch(err => {
                        console.error('ì£¼ë¬¸ìƒì„¸ ì¡°íšŒ ì‹¤íŒ¨:', err);
                        alert('ì£¼ë¬¸ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    });
            });
        });

        // 2. êµ¬ë§¤í™•ì • ë²„íŠ¼ (í˜ì´ì§€ì˜ .btn-confirm)
        document.querySelectorAll('.btn-confirm').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('confirmModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('confirmModal');
                }
            });
        });

        // 3. ëª¨ë‹¬ ë‚´ë¶€ì˜ êµ¬ë§¤í™•ì • í™•ì¸ ë²„íŠ¼ âœ… ì´ê²Œ í•µì‹¬!
        const confirmOrderBtn = document.getElementById('confirmOrderBtn');
        if (confirmOrderBtn) {
            confirmOrderBtn.addEventListener('click', function() {
                const modal = document.getElementById('confirmModal');
                const itemNo = modal.dataset.itemNo;

                fetch(`/shoply/my/order/confirm?item_no=${itemNo}`, {
                    method: 'POST'
                })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('êµ¬ë§¤í™•ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            closeModal('confirmModal');
                            location.reload();
                        } else {
                            alert('êµ¬ë§¤í™•ì • ì‹¤íŒ¨: ' + data);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
            });
        } else {
            console.error('âŒ confirmOrderBtnì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }

        // 4. ë¦¬ë·° ì‘ì„± ë²„íŠ¼
        document.querySelectorAll('.btn-review').forEach(btn => {
            btn.addEventListener('click', function() {
                const prodNo = this.getAttribute('data-prod-no');
                const prodName = this.getAttribute('data-prod-name');
                const prodNameDisplay = document.querySelector('.product-name-display');
                if(prodNameDisplay) {
                    prodNameDisplay.textContent = prodName;
                }
                document.getElementById('review_prod_no').value = prodNo;
                openModal('reviewModal');
            });
        });

        // 5. ë¦¬ë·° ì‘ì„± í¼ ì œì¶œ âœ… ì´ê²ƒë„ í•µì‹¬!
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const prodNo = document.getElementById('review_prod_no').value;
                const rating = document.querySelector('input[name="rating"]:checked')?.value || 3;
                const content = document.getElementById('review_content').value.trim();

                if (content.length < 10) {
                    alert('ë¦¬ë·° ë‚´ìš©ì€ ìµœì†Œ 10ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }

                const formData = new FormData();
                formData.append('prod_no', prodNo);
                formData.append('rating', rating);
                formData.append('content', content);
                formData.append('file1', document.querySelector('input[name="file1"]').files[0] || '');
                formData.append('file2', document.querySelector('input[name="file2"]').files[0] || '');
                formData.append('file3', document.querySelector('input[name="file3"]').files[0] || '');

                fetch('/shoply/my/review/write', {
                    method: 'POST',
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            alert('ë¦¬ë·°ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            closeModal('reviewModal');
                            reviewForm.reset();
                            location.reload();
                        } else {
                            alert('ë¦¬ë·° ì‘ì„± ì‹¤íŒ¨: ' + data.message);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
            });
        } else {
            console.error('âŒ reviewFormì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }

        // 6. ë°˜í’ˆ ë²„íŠ¼
        document.querySelectorAll('.btn-return').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('returnModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('returnModal');
                }
            });
        });

        // 7. ë°˜í’ˆ ì‹ ì²­ í¼
        const returnForm = document.getElementById('returnForm');
        if (returnForm) {
            returnForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const modal = document.getElementById('returnModal');
                const itemNo = modal.dataset.itemNo;
                const reason = returnForm.querySelector('select[name="reason"]').value;
                const detail = returnForm.querySelector('textarea[name="detail"]').value.trim();

                if (!reason) {
                    alert('ë°˜í’ˆ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (!detail) {
                    alert('ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const fullReason = reason + (detail ? ' - ' + detail : '');

                fetch(`/shoply/my/order/return?item_no=${itemNo}&reason=${encodeURIComponent(fullReason)}`, {
                    method: 'POST'
                })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('ë°˜í’ˆ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            closeModal('returnModal');
                            returnForm.reset();
                            location.reload();
                        } else {
                            alert('ë°˜í’ˆ ì‹ ì²­ ì‹¤íŒ¨: ' + data);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
            });
        }

        // 8. êµí™˜ ë²„íŠ¼
        document.querySelectorAll('.btn-exchange').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('exchangeModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('exchangeModal');
                }
            });
        });

        // 9. êµí™˜ ì‹ ì²­ í¼
        const exchangeForm = document.getElementById('exchangeForm');
        if (exchangeForm) {
            exchangeForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const modal = document.getElementById('exchangeModal');
                const itemNo = modal.dataset.itemNo;
                const reason = exchangeForm.querySelector('select[name="reason"]').value;
                const detail = exchangeForm.querySelector('textarea[name="detail"]').value.trim();

                if (!reason) {
                    alert('êµí™˜ ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (!detail) {
                    alert('ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const fullReason = reason + (detail ? ' - ' + detail : '');

                fetch(`/shoply/my/order/exchange?item_no=${itemNo}&reason=${encodeURIComponent(fullReason)}`, {
                    method: 'POST'
                })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('êµí™˜ ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            closeModal('exchangeModal');
                            exchangeForm.reset();
                            location.reload();
                        } else {
                            alert('êµí™˜ ì‹ ì²­ ì‹¤íŒ¨: ' + data);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
            });
        }

        // 10. ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼
        const passwordForm = document.getElementById('passwordForm');
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value.trim();
                const newPassword = document.getElementById('newPassword').value.trim();
                const confirmPassword = document.getElementById('confirmPassword').value.trim();

                if (!currentPassword) {
                    alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (!newPassword) {
                    alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                if (newPassword.length < 6) {
                    alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }

                fetch('/shoply/my/info/changePassword', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newPassword: newPassword
                    })
                })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            closeModal('passwordModal');
                            passwordForm.reset();
                        } else {
                            alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨: ' + data);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
            });
        }

        // 11. ë³„ì  í‘œì‹œ
        document.querySelectorAll('.star-rating').forEach(el => {
            const rating = parseInt(el.textContent.trim());
            if (!isNaN(rating)) {
                el.textContent = 'â˜…'.repeat(rating);
            }
        });

        // 12. ì‘ì„±í•œ ë¦¬ë·° ë³´ê¸° ë²„íŠ¼
        document.querySelectorAll('.btn-view-review').forEach(btn => {
            btn.addEventListener('click', function() {
                const prodNo = this.getAttribute('data-prod-no');
                const prodName = this.getAttribute('data-prod-name');

                console.log('ë¦¬ë·° ì¡°íšŒ ì‹œì‘:', prodNo, prodName);

                fetch(`/shoply/my/review/detail?prod_no=${prodNo}`)
                    .then(res => {
                        if (!res.ok) throw new Error(`HTTP ì˜¤ë¥˜: ${res.status}`);
                        return res.json();
                    })
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }

                        if (data && data.rev_rating !== undefined) {
                            const titleEl = document.getElementById('reviewDetailTitle');
                            const ratingEl = document.getElementById('reviewDetailRating');
                            const contentEl = document.getElementById('reviewDetailContent');
                            const dateEl = document.getElementById('reviewDetailDate');
                            const imageEl = document.getElementById('reviewDetailImages');

                            if (!titleEl || !ratingEl || !contentEl || !dateEl || !imageEl) {
                                console.error('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                alert('ëª¨ë‹¬ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                                return;
                            }

                            titleEl.textContent = prodName || 'ìƒí’ˆëª… ì—†ìŒ';
                            ratingEl.textContent = 'â˜…'.repeat(data.rev_rating || 0);
                            contentEl.textContent = data.rev_content || '-';

                            if (data.rev_rdate) {
                                let dateStr = data.rev_rdate;
                                if (dateStr.includes('T')) {
                                    dateStr = dateStr.split('T')[0];
                                }
                                dateEl.textContent = dateStr;
                            } else {
                                dateEl.textContent = '-';
                            }

                            imageEl.innerHTML = '';

                            if (data.rev_files && Array.isArray(data.rev_files) && data.rev_files.length > 0) {
                                data.rev_files.forEach((file, index) => {
                                    let imagePath = file.trim();

                                    if (!imagePath.startsWith('/')) {
                                        imagePath = `/uploads/review/${imagePath}`;
                                    } else if (!imagePath.startsWith('/uploads/')) {
                                        imagePath = `/uploads/review/${imagePath}`;
                                    }

                                    const img = document.createElement('img');
                                    img.src = imagePath;
                                    img.alt = `ë¦¬ë·° ì´ë¯¸ì§€ ${index + 1}`;
                                    img.style.cssText = 'width: 150px; height: 150px; margin: 5px; border-radius: 4px; object-fit: cover; cursor: pointer; border: 1px solid #ddd;';

                                    img.onerror = function() {
                                        this.style.border = '2px solid #ff6b6b';
                                        this.title = 'ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + imagePath;
                                    };

                                    img.onclick = function() {
                                        window.open(this.src, '_blank');
                                    };

                                    imageEl.appendChild(img);
                                });
                            } else {
                                imageEl.innerHTML = '<span style="color: #999; display: inline-block; padding: 20px;">(ì´ë¯¸ì§€ ì—†ìŒ)</span>';
                            }

                            openModal('reviewDetailModal');
                        }
                    })
                    .catch(err => {
                        console.error('ë¦¬ë·° ì¡°íšŒ ì‹¤íŒ¨:', err);
                        alert('ë¦¬ë·° ì¡°íšŒ ì‹¤íŒ¨: ' + err.message);
                    });
            });
        });

        // 13. íŒë§¤ì ì •ë³´ íŒì—…ì˜ ë¬¸ì˜í•˜ê¸° ë²„íŠ¼
        const sellerModal = document.getElementById('sellerInfoPopup');
        if (sellerModal) {
            const inquiryBtn = sellerModal.querySelector('button');
            if (inquiryBtn) {
                inquiryBtn.addEventListener('click', function() {
                    openModal('qnaPopup');
                    closeModal('sellerInfoPopup');
                });
            }
        }

        console.log('Modal DOMContentLoaded ì™„ë£Œ');
    });

    // ===== íŒë§¤ì ì •ë³´ ì¡°íšŒ (ì™¸ë¶€ í•¨ìˆ˜) =====
    function openSellerInfo(memId) {
        fetch(`/shoply/my/seller/info?mem_id=${memId}`)
            .then(res => res.json())
            .then(data => {
                if (data) {
                    const gradeStyles = {
                        'DIAMOND': { color: '#00D4FF', badge: 'ğŸ’ DIAMOND' },
                        'GOLD': { color: '#FFD700', badge: 'â­ GOLD' },
                        'SILVER': { color: '#C0C0C0', badge: 'âœ¨ SILVER' },
                        'BRONZE': { color: '#CD7F32', badge: 'ğŸ”¶ BRONZE' }
                    };

                    const gradeInfo = gradeStyles[data.sellerGrade] || gradeStyles['BRONZE'];
                    const sellerModal = document.querySelector('#sellerInfoPopup .info-table tbody');

                    sellerModal.innerHTML = `
                        <tr>
                            <td class="label" style="width: 150px;">íŒë§¤ì ë“±ê¸‰</td>
                            <td style="color: ${gradeInfo.color}; font-weight: bold;">${gradeInfo.badge}</td>
                        </tr>
                        <tr>
                            <td class="label">ìƒí˜¸</td>
                            <td>${data.corpName || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">ëŒ€í‘œì</td>
                            <td>${data.memName || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">ì „í™”ë²ˆí˜¸</td>
                            <td>${data.corpTelHp || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">FAX</td>
                            <td>${data.corpFax || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">ì‚¬ì—…ìë²ˆí˜¸</td>
                            <td>${data.corpRegHp || '-'}</td>
                        </tr>
                        <tr>
                            <td class="label">ì˜ì—…ì†Œì¬ì§€</td>
                            <td>[${data.memZip}] ${data.memAddr1} ${data.memAddr2 || ''}</td>
                        </tr>
                        <tr>
                            <td class="label">ëˆ„ì  íŒë§¤ì•¡</td>
                            <td>${Number(data.totSellPrice).toLocaleString('ko-KR')}ì›</td>
                        </tr>
                    `;

                    openModal('sellerInfoPopup');
                }
            })
            .catch(err => {
                console.error('íŒë§¤ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', err);
                alert('íŒë§¤ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            });
    }
</script>
