<!-- order.html -->
<div th:replace="~{my/_head.html}"></div>

<main class="container">
    <div class="sidebar">
        <ul>
            <li><a th:href="@{/my/home}">마이페이지 홈</a></li>
            <li><a th:href="@{/my/order}" class="active">전체주문내역</a></li>
            <li><a th:href="@{/my/point}">포인트내역</a></li>
            <li><a th:href="@{/my/coupon}">쿠폰</a></li>
            <li><a th:href="@{/my/review}">나의리뷰</a></li>
            <li><a th:href="@{/my/qna}">문의하기</a></li>
            <li><a th:href="@{/my/info}">나의설정</a></li>
        </ul>
    </div>
    <div class="content">
        <div class="main-content-header">
            <h2>나의 쇼핑 정보</h2>
            <div class="info-summary">
                <div class="info-item">
                    <div class="count" th:text="${orderCount}">2</div>
                    <div>주문</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${couponCount}">1</div>
                    <div>쿠폰</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${#numbers.formatInteger(pointTotal, 0, 'COMMA')}">1,000</div>
                    <div>포인트</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${qnaCount}">1</div>
                    <div>문의</div>
                </div>
            </div>
        </div>

        <!-- 배너 -->
        <div class="banner" th:if="${banner != null}" th:style="'background-color:' + ${banner.ban_bg_color}">
            <img th:if="${banner.ban_img != null}"
                 th:src="@{'/uploads/banner/' + ${banner.ban_img}}"
                 alt="배너" style="width:100%; height:100%; object-fit:cover;">
            <span th:if="${banner.ban_img == null}">810 x 86 배너 광고</span>
        </div>

        <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
            <h3 style="margin-top: 0;">기간별 조회</h3>
            <form id="periodForm" method="get" th:action="@{/my/order}" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">

                <!-- 빠른 선택 버튼 -->
                <div style="display: flex; gap: 8px;">
                    <button type="button" class="period-btn" data-period="1day" style="padding: 8px 15px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">1일</button>
                    <button type="button" class="period-btn" data-period="1week" style="padding: 8px 15px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">1주일</button>
                    <button type="button" class="period-btn" data-period="1month" style="padding: 8px 15px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">1개월</button>
                </div>

                <!-- 개월 선택 -->
                <div>
                    <select id="monthSelect" name="month" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">개월 선택</option>
                        <option value="3">3개월</option>
                        <option value="6">6개월</option>
                        <option value="12">12개월</option>
                    </select>
                </div>

                <!-- 커스텀 기간 (년월일) -->
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="font-weight: bold;">기간:</span>
                    <input type="date" id="startMonth" name="startMonth" placeholder="시작 날짜" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <span>~</span>
                    <input type="date" id="endMonth" name="endMonth" placeholder="종료 날짜" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <!-- 숨겨진 기간 값 -->
                <input type="hidden" id="periodType" name="periodType" value="">
                <input type="hidden" id="period" name="period" value="">

                <!-- 조회 버튼 -->
                <button type="submit" style="padding: 8px 20px; background: #946ccf; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">조회</button>

                <!-- 초기화 버튼 -->
                <button type="button" id="resetBtn" style="padding: 8px 20px; background: #ddd; color: #333; border: none; border-radius: 4px; cursor: pointer;">초기화</button>
            </form>
        </div>

        <table class="table-container">
            <thead>
            <tr>
                <th>날짜</th>
                <th>상품정보</th>
                <th>상태</th>
                <th>확인/신청</th>
            </tr>
            </thead>
            <tbody id="orderTableBody">
            <tr th:each="orderItem : ${orderPage.content}">
                <td th:text="${#dates.format(orderItem.ord_date, 'yyyy-MM-dd')}">2022-12-13</td>
                <td>
                    <div class="product-info">
                        <img th:if="${productMap[orderItem.prod_no] != null and productMap[orderItem.prod_no].files != null and productMap[orderItem.prod_no].files.size() > 0}"
                             th:src="@{'/uploads/' + ${productMap[orderItem.prod_no].files[0].f_name}}"
                             alt="상품 이미지" style="width: 80px; height: 80px; border-radius: 4px;">
                        <img th:if="${productMap[orderItem.prod_no] == null or productMap[orderItem.prod_no].files == null or productMap[orderItem.prod_no].files.size() == 0}"
                             th:src="@{'/image/product/cap_3_thumb2.jpg'}" alt="기본 이미지" style="width: 80px; height: 80px; border-radius: 4px;">
                        <div class="product-details">
                            <p>주문번호:
                                <a href="#"
                                   class="order-number-link"
                                   th:text="${orderItem.ord_no}"
                                   th:data-ord-no="${orderItem.ord_no}"
                                   th:data-item-no="${orderItem.item_no}"
                                   style="color: #0066cc; text-decoration: none;">1012211341</a>
                            </p>
                            <span th:text="${productMap[orderItem.prod_no] != null ? productMap[orderItem.prod_no].prod_name : '상품명 없음'}">상품명</span>
                            <p>수량: <span th:text="${orderItem.item_cnt}">1</span>개</p>
                            <strong th:if="${productMap[orderItem.prod_no] != null}"
                                    th:text="${#numbers.formatInteger(productMap[orderItem.prod_no].prod_price, 0, 'COMMA')} + '원'">34,000원</strong>
                            <strong th:if="${productMap[orderItem.prod_no] == null}">가격 정보 없음</strong>
                        </div>
                    </div>
                </td>
                <td th:switch="${orderItem.item_stat}">
                    <span th:case="0">결제완료</span>
                    <span th:case="1">배송준비</span>
                    <span th:case="2">배송중</span>
                    <span th:case="3">배송완료</span>
                    <span th:case="4">구매확정</span>
                    <span th:case="5">교환신청</span>
                    <span th:case="6">반품신청</span>
                    <span th:case="*">상태없음</span>
                </td>

                <td>
                    <br>
                    <button class="btn-confirm"
                            th:data-item-no="${orderItem.item_no}"
                            th:disabled="${orderItem.item_stat > 3}">구매확정</button>
                    <button class="btn-review"
                            th:data-prod-no="${orderItem.prod_no}"
                            th:data-prod-name="${orderItem.item_name}"
                            th:disabled="${orderItem.item_stat != 4}">상품평쓰기</button>
                    <button class="btn-return"
                            th:data-item-no="${orderItem.item_no}"
                            th:disabled="${orderItem.item_stat > 3}">반품신청</button>
                    <button class="btn-exchange"
                            th:data-item-no="${orderItem.item_no}"
                            th:disabled="${orderItem.item_stat != 3}">교환신청</button>
                    <br>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(orderPage.content)}">
                <td colspan="4" style="text-align: center;">주문 내역이 없습니다.</td>
            </tr>
            </tbody>
        </table>

        <!-- 페이징 -->
        <div style="text-align: center; margin: 30px 0; padding: 20px; background: #f9f9f9; border-radius: 8px;">
            <!-- 첫 페이지 -->
            <a th:if="${orderPage.number > 0}"
               th:href="@{/my/order(page=0)}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
              border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
              background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">«</a>
            <span th:unless="${orderPage.number > 0}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                background: #f5f5f5; color: #ccc; font-weight: bold;">«</span>

            <!-- 이전 페이지 -->
            <a th:if="${orderPage.hasPrevious()}"
               th:href="@{/my/order(page=${orderPage.number - 1})}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
              border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
              background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">‹</a>
            <span th:unless="${orderPage.hasPrevious()}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                background: #f5f5f5; color: #ccc; font-weight: bold;">‹</span>

            <!-- 페이지 번호 -->
            <th:block th:each="i : ${#numbers.sequence(0, orderPage.totalPages - 1)}">
                <a th:if="${i != orderPage.number}"
                   th:href="@{/my/order(page=${i})}"
                   th:text="${i + 1}"
                   style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                  border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                  background: #fff; color: #555; text-decoration: none; font-weight: 600;"></a>
                <span th:if="${i == orderPage.number}"
                      th:text="${i + 1}"
                      style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                    border: 1px solid #946ccf; border-radius: 6px; margin: 0 2px;
                    background: linear-gradient(135deg, #a86cc1, #946ccf); color: #fff;
                    font-weight: 700;"></span>
            </th:block>

            <!-- 다음 페이지 -->
            <a th:if="${orderPage.hasNext()}"
               th:href="@{/my/order(page=${orderPage.number + 1})}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
              border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
              background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">›</a>
            <span th:unless="${orderPage.hasNext()}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                background: #f5f5f5; color: #ccc; font-weight: bold;">›</span>

            <!-- 마지막 페이지 -->
            <a th:if="${orderPage.number < orderPage.totalPages - 1}"
               th:href="@{/my/order(page=${orderPage.totalPages - 1})}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
              border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
              background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">»</a>
            <span th:unless="${orderPage.number < orderPage.totalPages - 1}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                background: #f5f5f5; color: #ccc; font-weight: bold;">»</span>

            <div style="margin-top: 12px; font-size: 13px; color: #999;">
                <th:block th:text="${orderPage.number + 1} + ' / ' + ${orderPage.totalPages}"></th:block>
            </div>
        </div>
    </div>
</main>

<div th:replace="~{my/modal.html}"></div>
<div th:replace="~{my/_tail.html}"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        // ===== 주문번호 클릭 시 상세정보 조회 =====
        document.querySelectorAll('.order-number-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const ordNo = this.getAttribute('data-ord-no');
                const itemNo = this.getAttribute('data-item-no');

                fetch(`/shoply/my/order/detail?ord_no=${ordNo}&item_no=${itemNo}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data) {
                            // 주문정보 채우기
                            document.getElementById('orderNo').textContent = data.ordNo || '-';
                            document.getElementById('orderProdName').textContent = data.prodName || '상품명 없음';
                            document.getElementById('orderQty').textContent = data.itemCnt || '-';
                            document.getElementById('orderProdPrice').textContent = (data.prodPrice ? formatPrice(data.prodPrice) : '-');
                            document.getElementById('orderDiscount').textContent = (data.discount ? '-' + formatPrice(data.discount) : '0원');
                            document.getElementById('orderTotalPrice').textContent = (data.totalPrice ? formatPrice(data.totalPrice) : '-');

                            // 배송상태 표시
                            const statusText = getStatusText(data.itemStat);
                            document.getElementById('orderStatus').textContent = statusText;
                            document.getElementById('orderDate').textContent = data.ordDate || '-';

                            // 상품 이미지
                            if (data.prodImage) {
                                document.getElementById('orderDetailImage').src = '/uploads/' + data.prodImage;
                            }

                            // 배송정보 채우기
                            document.getElementById('deliveryName').textContent = data.memName || '-';
                            document.getElementById('deliveryPhone').textContent = data.memHp || '-';
                            const addr = (data.memAddr1 ? '[' + data.memZip + '] ' + data.memAddr1 : '-');
                            document.getElementById('deliveryAddr').textContent = addr + (data.memAddr2 ? ' ' + data.memAddr2 : '');
                            document.getElementById('deliveryMemo').textContent = data.deliveryMemo || '없음';

                            // 모달 열기
                            openModal('orderDetailPopup');
                        }
                    })
                    .catch(err => {
                        console.error('주문상세 조회 실패:', err);
                        alert('주문정보를 불러올 수 없습니다.');
                    });
            });
        });

        function formatPrice(price) {
            if (!price) return '0원';
            return parseInt(price).toLocaleString('ko-KR') + '원';
        }

        function getStatusText(stat) {
            const statusMap = {
                0: '결제완료', 1: '배송준비', 2: '배송중',
                3: '배송완료', 4: '구매확정', 5: '교환신청', 6: '반품신청'
            };
            return statusMap[stat] || '상태없음';
        }

        // 구매확정 버튼
        document.querySelectorAll('.btn-confirm').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('confirmModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('confirmModal');
                }
            });
        });

        // 리뷰 작성 버튼
        document.querySelectorAll('.btn-review').forEach(btn => {
            btn.addEventListener('click', function() {
                const prodNo = this.getAttribute('data-prod-no');
                const prodName = this.getAttribute('data-prod-name');
                const prodNameDisplay = document.querySelector('.product-name-display');
                if(prodNameDisplay) {
                    prodNameDisplay.textContent = prodName;
                }
                document.getElementById('review_prod_no').value = prodNo;
                openModal('reviewModal');
            });
        });

        // 반품 버튼
        document.querySelectorAll('.btn-return').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('returnModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('returnModal');
                }
            });
        });

        // 교환 버튼
        document.querySelectorAll('.btn-exchange').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemNo = this.getAttribute('data-item-no');
                const modal = document.getElementById('exchangeModal');
                if(modal) {
                    modal.dataset.itemNo = itemNo;
                    openModal('exchangeModal');
                }
            });
        });
    });

    // 페이지 이동
    function goPage(page) {
        window.location.href = `/shoply/my/order?page=${page}`;
    }

    function openModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'block';
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const periodBtns = document.querySelectorAll('.period-btn');
        const monthSelect = document.getElementById('monthSelect');
        const startMonth = document.getElementById('startMonth');
        const endMonth = document.getElementById('endMonth');
        const periodType = document.getElementById('periodType');
        const periodInput = document.getElementById('period');
        const resetBtn = document.getElementById('resetBtn');
        const periodForm = document.getElementById('periodForm');

        // 빠른 선택 버튼
        periodBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                periodBtns.forEach(b => b.style.background = '#fff');
                this.style.background = '#946ccf';
                this.style.color = '#fff';

                periodType.value = this.getAttribute('data-period');
                monthSelect.value = '';
                startMonth.value = '';
                endMonth.value = '';
                periodForm.submit();
            });
        });

        // 개월 선택
        monthSelect.addEventListener('change', function() {
            if(this.value) {
                periodBtns.forEach(b => b.style.background = '#fff');
                periodType.value = 'month';
                periodInput.value = this.value;
                startMonth.value = '';
                endMonth.value = '';
                periodForm.submit();
            }
        });

        // 커스텀 기간 (조회 버튼 클릭)
        periodForm.addEventListener('submit', function(e) {
            if(!periodType.value && !periodInput.value && !startMonth.value && !endMonth.value) {
                return true;
            }

            if(startMonth.value && endMonth.value) {
                periodType.value = 'custom';
                periodInput.value = '';
            }
        });

        // 초기화
        resetBtn.addEventListener('click', function() {
            periodBtns.forEach(b => b.style.background = '#fff');
            monthSelect.value = '';
            startMonth.value = '';
            endMonth.value = '';
            periodType.value = '';
            periodInput.value = '';
            window.location.href = '/shoply/my/order';
        });
    });
</script>