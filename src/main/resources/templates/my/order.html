<!-- order.html -->
<div th:replace="~{my/_head.html}"></div>

<main class="container">
    <div class="sidebar">
        <ul>
            <li><a th:href="@{/my/home}">마이페이지 홈</a></li>
            <li><a th:href="@{/my/order}" class="active">전체주문내역</a></li>
            <li><a th:href="@{/my/point}">포인트내역</a></li>
            <li><a th:href="@{/my/coupon}">쿠폰</a></li>
            <li><a th:href="@{/my/review}">나의리뷰</a></li>
            <li><a th:href="@{/my/qna}">문의하기</a></li>
            <li><a th:href="@{/my/info}">나의설정</a></li>
        </ul>
    </div>
    <div class="content">
        <div class="main-content-header">
            <h2>나의 쇼핑 정보</h2>
            <div class="info-summary">
                <div class="info-item">
                    <div class="count" th:text="${orderCount}">2</div>
                    <div>주문</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${couponCount}">1</div>
                    <div>쿠폰</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${#numbers.formatInteger(pointTotal, 0, 'COMMA')}">1,000</div>
                    <div>포인트</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${qnaCount}">1</div>
                    <div>문의</div>
                </div>
            </div>
        </div>

        <!-- 배너 -->
        <div class="banner" th:if="${banner != null}" th:style="'background-color:' + ${banner.ban_bg_color}">
            <img th:if="${banner.ban_img != null}"
                 th:src="@{${banner.ban_img}}"
                 alt="배너" style="width:100%; height:100%; object-fit:cover;">
            <span th:if="${banner.ban_img == null}">810 x 86 배너 광고</span>
        </div>
        <h3>주문내역</h3>
        <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
            <h3 style="margin-top: 0;">기간별 조회</h3>
            <form id="periodForm" method="get" th:action="@{/my/order}" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">

                <!-- 빠른 선택 버튼 -->
                <div style="display: flex; gap: 8px;">
                    <button type="button" class="period-btn" data-period="1day" style="padding: 8px 15px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">1일</button>
                    <button type="button" class="period-btn" data-period="1week" style="padding: 8px 15px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">1주일</button>
                    <button type="button" class="period-btn" data-period="1month" style="padding: 8px 15px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">1개월</button>
                </div>

                <!-- 개월 선택 -->
                <div>
                    <select id="monthSelect" name="month" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">개월 선택</option>
                        <option value="3">3개월</option>
                        <option value="6">6개월</option>
                        <option value="12">12개월</option>
                    </select>
                </div>

                <!-- 커스텀 기간 (년월일) -->
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span style="font-weight: bold;">기간:</span>
                    <input type="date" id="startMonth" name="startMonth" placeholder="시작 날짜" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <span>~</span>
                    <input type="date" id="endMonth" name="endMonth" placeholder="종료 날짜" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>

                <!-- 숨겨진 기간 값 -->
                <input type="hidden" id="periodType" name="periodType" value="">
                <input type="hidden" id="period" name="period" value="">

                <!-- 조회 버튼 -->
                <button type="submit" style="padding: 8px 20px; background: #946ccf; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">조회</button>

                <!-- 초기화 버튼 -->
                <button type="button" id="resetBtn" style="padding: 8px 20px; background: #ddd; color: #333; border: none; border-radius: 4px; cursor: pointer;">초기화</button>
            </form>
        </div>

        <table class="table-container btnsContainer">
            <thead>
            <tr>
                <th>날짜</th>
                <th>상품정보</th>
                <th>상태</th>
                <th>확인 / 신청</th>
            </tr>
            </thead>
            <tbody id="orderTableBody">
            <tr th:each="orderItem : ${orderPage.content}">
                <td th:text="${#dates.format(orderItem.ord_date, 'yyyy-MM-dd HH:mm')}">2022-12-13</td>
                <td>
                    <div class="product-info">
                        <!-- 상품 이미지 -->
                        <img th:if="${productMap[orderItem.prod_no] != null and productMap[orderItem.prod_no].files != null and productMap[orderItem.prod_no].files.size() > 0}"
                             th:src="${productMap[orderItem.prod_no].files[0].f_name}"
                             alt="상품 이미지"
                             style="width: 80px; height: 80px; border-radius: 4px; object-fit: cover;">
                        <img th:if="${productMap[orderItem.prod_no] == null or productMap[orderItem.prod_no].files == null or productMap[orderItem.prod_no].files.size() == 0}"
                             th:src="@{'/image/product/cap_3_thumb2.jpg'}" alt="기본 이미지" style="width: 80px; height: 80px; border-radius: 4px;">

                        <div class="product-details">
                            <!-- 주문번호 -->
                            <p>주문번호 :
                                <a href="#"
                                   class="order-number-link"
                                   th:text="${orderItem.ord_no}"
                                   th:data-ord-no="${orderItem.ord_no}"
                                   th:data-item-no="${orderItem.item_no}"
                                   style="color: #0066cc; text-decoration: none;"></a>
                            </p>

                            <!-- 판매자명 (productMap이 null이 아닐 때만) -->
                            <th:block th:if="${productMap[orderItem.prod_no] != null}">
                                <p>(주) <a href="#"
                                          th:data-mem-id="${productMap[orderItem.prod_no].mem_id}"
                                          th:text="${productMap[orderItem.prod_no].corpName ?: '상호명'}"
                                          onclick="openSellerInfo(this.getAttribute('data-mem-id')); return false;"
                                          style="cursor: pointer; color: #0066cc; text-decoration: none;"></a></p>

                                <!-- 상품명 (링크) -->
                                <a th:href="|/shoply/product/view/9/${productMap[orderItem.prod_no].prod_no}|"
                                   th:text="${productMap[orderItem.prod_no].prod_name ?: '상품명 없음'}"
                                   style="color: #0066cc; text-decoration: none; font-weight: 500; cursor: pointer; display: block; margin: 5px 0;"></a>

                                <!-- 가격 -->
                                <strong th:text="${#numbers.formatInteger(productMap[orderItem.prod_no].prod_price, 0, 'COMMA')} + '원'">
                                    가격정보
                                </strong>
                            </th:block>

                            <!-- 상품 정보가 없을 때 -->
                            <th:block th:if="${productMap[orderItem.prod_no] == null}">
                                <p>(주) 상호명</p>
                                <p style="color: #999;">상품명 없음</p>
                                <strong>가격 정보 없음</strong>
                            </th:block>

                            <!-- 수량 -->
                            <p>수량 : <span th:text="${orderItem.item_cnt}">1</span>개</p>
                        </div>
                    </div>
                </td>
                <td th:switch="${orderItem.item_stat}">
                    <span th:case="0">결제완료</span>
                    <span th:case="1">배송준비</span>
                    <span th:case="2">배송중</span>
                    <span th:case="3">배송완료</span>
                    <span th:case="4">구매확정</span>
                    <span th:case="5">교환신청</span>
                    <span th:case="6">반품신청</span>
                    <span th:case="*">상태없음</span>
                </td>

                <td>
                    <br>
                    <button class="btn-confirm"
                            th:data-item-no="${orderItem.item_no}"
                            th:disabled="${orderItem.item_stat != 3}">구매확정</button>

                    <!-- 리뷰 버튼 (reviewCheckMap이 존재하고 리뷰가 있는 경우) -->
                    <button th:if="${reviewCheckMap != null and reviewCheckMap[orderItem.prod_no] == true}"
                            class="btn-view-review"
                            th:data-prod-no="${orderItem.prod_no}"
                            th:data-prod-name="${productMap[orderItem.prod_no] != null ? productMap[orderItem.prod_no].prod_name : '상품명'}"
                            style="background-color: #28a745; cursor: pointer;">작성한 리뷰 보기</button>

                    <!-- 리뷰가 없는 경우 -->
                    <button th:if="${reviewCheckMap == null or reviewCheckMap[orderItem.prod_no] != true}"
                            class="btn-review"
                            th:data-prod-no="${orderItem.prod_no}"
                            th:data-prod-name="${orderItem.item_name}"
                            th:disabled="${orderItem.item_stat != 4}">상품평쓰기</button>

                    <button class="btn-return"
                            th:data-item-no="${orderItem.item_no}"
                            th:disabled="${orderItem.item_stat > 3}">반품신청</button>
                    <button class="btn-exchange"
                            th:data-item-no="${orderItem.item_no}"
                            th:disabled="${orderItem.item_stat != 3}">교환신청</button>
                    <br>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(orderPage.content)}">
                <td colspan="4" style="text-align: center;">주문 내역이 없습니다.</td>
            </tr>
            </tbody>
        </table>
        <!-- 페이징 --><div style="text-align: center; margin: 30px 0; padding: 20px; background: #f9f9f9; border-radius: 8px;">
        <!-- 첫 페이지 -->
        <a th:if="${orderPage.number > 0}"
           th:href="@{/my/order(page=0, periodType=${periodType}, period=${period}, startMonth=${startMonth}, endMonth=${endMonth})}"
           style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
              border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
              background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">«</a>
        <span th:unless="${orderPage.number > 0}"
              style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                background: #f5f5f5; color: #ccc; font-weight: bold;">«</span>

        <!-- 이전 페이지 -->
        <a th:if="${orderPage.hasPrevious()}"
           th:href="@{/my/order(page=${orderPage.number - 1}, periodType=${periodType}, period=${period}, startMonth=${startMonth}, endMonth=${endMonth})}"
           style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
              border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
              background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">‹</a>
        <span th:unless="${orderPage.hasPrevious()}"
              style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                background: #f5f5f5; color: #ccc; font-weight: bold;">‹</span>

        <!-- 페이지 번호 -->
        <th:block th:each="i : ${#numbers.sequence(0, orderPage.totalPages - 1)}">
            <a th:if="${i != orderPage.number}"
               th:href="@{/my/order(page=${i}, periodType=${periodType}, period=${period}, startMonth=${startMonth}, endMonth=${endMonth})}"
               th:text="${i + 1}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                  border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                  background: #fff; color: #555; text-decoration: none; font-weight: 600;"></a>
            <span th:if="${i == orderPage.number}"
                  th:text="${i + 1}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                    border: 1px solid #946ccf; border-radius: 6px; margin: 0 2px;
                    background: linear-gradient(135deg, #a86cc1, #946ccf); color: #fff;
                    font-weight: 700;"></span>
        </th:block>

        <!-- 다음 페이지 -->
        <a th:if="${orderPage.hasNext()}"
           th:href="@{/my/order(page=${orderPage.number + 1}, periodType=${periodType}, period=${period}, startMonth=${startMonth}, endMonth=${endMonth})}"
           style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
              border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
              background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">›</a>
        <span th:unless="${orderPage.hasNext()}"
              style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                background: #f5f5f5; color: #ccc; font-weight: bold;">›</span>

        <!-- 마지막 페이지 -->
        <a th:if="${orderPage.number < orderPage.totalPages - 1}"
           th:href="@{/my/order(page=${orderPage.totalPages - 1}, periodType=${periodType}, period=${period}, startMonth=${startMonth}, endMonth=${endMonth})}"
           style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
              border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
              background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">»</a>
        <span th:unless="${orderPage.number < orderPage.totalPages - 1}"
              style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                background: #f5f5f5; color: #ccc; font-weight: bold;">»</span>

        <div style="margin-top: 12px; font-size: 13px; color: #999;">
            <th:block th:text="${orderPage.number + 1} + ' / ' + ${orderPage.totalPages}"></th:block>
        </div>
    </div>
    </div>
</main>

<div th:replace="~{my/modal.html}"></div>
<div th:replace="~{my/_tail.html}"></div>

<script>
    function goPage(page) {
        //  현재 필터 파라미터를 가져와서 전달
        const urlParams = new URLSearchParams(window.location.search);
        const periodType = urlParams.get('periodType') || '';
        const period = urlParams.get('period') || '';
        const startMonth = urlParams.get('startMonth') || '';
        const endMonth = urlParams.get('endMonth') || '';

        let url = `/shoply/my/order?page=${page}`;
        if (periodType) url += `&periodType=${periodType}`;
        if (period) url += `&period=${period}`;
        if (startMonth) url += `&startMonth=${startMonth}`;
        if (endMonth) url += `&endMonth=${endMonth}`;

        window.location.href = url;
    }

    function openModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'block';
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        const periodBtns = document.querySelectorAll('.period-btn');
        const monthSelect = document.getElementById('monthSelect');
        const startMonth = document.getElementById('startMonth');
        const endMonth = document.getElementById('endMonth');
        const periodType = document.getElementById('periodType');
        const periodInput = document.getElementById('period');
        const resetBtn = document.getElementById('resetBtn');
        const periodForm = document.getElementById('periodForm');

        //  URL에서 현재 필터 상태 확인
        const urlParams = new URLSearchParams(window.location.search);
        const currentPeriodType = urlParams.get('periodType');
        const currentPeriod = urlParams.get('period');

        // 빠른 선택 버튼
        periodBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                // 모든 버튼 스타일 초기화
                periodBtns.forEach(b => {
                    b.style.background = '#fff';
                    b.style.color = '#333';
                });

                // 클릭된 버튼 스타일 변경
                this.style.background = '#946ccf';
                this.style.color = '#fff';

                periodType.value = this.getAttribute('data-period');
                monthSelect.value = '';
                startMonth.value = '';
                endMonth.value = '';
                periodInput.value = '';

                //  폼 제출 (page=0으로 자동 리셋)
                periodForm.submit();
            });
        });

        // 개월 선택
        monthSelect.addEventListener('change', function() {
            if(this.value) {
                // 버튼 선택 해제
                periodBtns.forEach(b => {
                    b.style.background = '#fff';
                    b.style.color = '#333';
                });

                periodType.value = 'month';
                periodInput.value = this.value;
                startMonth.value = '';
                endMonth.value = '';

                //  폼 제출 (page=0으로 자동 리셋)
                periodForm.submit();
            }
        });

        // 커스텀 기간 (조회 버튼 클릭)
        periodForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const hasFilter = periodType.value || periodInput.value ||
                (startMonth.value && endMonth.value);

            if (startMonth.value && endMonth.value) {
                periodType.value = 'custom';
                periodInput.value = '';
            }

            //  폼을 동적으로 구성해서 page=0 파라미터 추가
            const formData = new FormData();
            formData.append('page', '0');  //  페이지는 항상 0으로

            if (periodType.value) {
                formData.append('periodType', periodType.value);
            }
            if (periodInput.value) {
                formData.append('period', periodInput.value);
            }
            if (startMonth.value) {
                formData.append('startMonth', startMonth.value);
            }
            if (endMonth.value) {
                formData.append('endMonth', endMonth.value);
            }

            //  URL 생성 및 이동
            const params = new URLSearchParams(formData);
            window.location.href = '/shoply/my/order?' + params.toString();
        });

        // 초기화 버튼
        resetBtn.addEventListener('click', function() {
            periodBtns.forEach(b => {
                b.style.background = '#fff';
                b.style.color = '#333';
            });
            monthSelect.value = '';
            startMonth.value = '';
            endMonth.value = '';
            periodType.value = '';
            periodInput.value = '';

            //  초기 페이지로 이동
            window.location.href = '/shoply/my/order';
        });

        //  페이지 로드 시 현재 필터 상태 표시
        if (currentPeriodType) {
            periodBtns.forEach(btn => {
                if (btn.getAttribute('data-period') === currentPeriodType) {
                    btn.style.background = '#946ccf';
                    btn.style.color = '#fff';
                }
            });
        }

        if (currentPeriod && currentPeriodType === 'month') {
            monthSelect.value = currentPeriod;
        }
    });
</script>