<!-- qna.hmtl-->
<div th:replace="~{my/_head.html}"></div>

<main class="container">
    <div class="sidebar">
        <ul>
            <li><a th:href="@{/my/home}">마이페이지 홈</a></li>
            <li><a th:href="@{/my/order}">전체주문내역</a></li>
            <li><a th:href="@{/my/point}">포인트내역</a></li>
            <li><a th:href="@{/my/coupon}">쿠폰</a></li>
            <li><a th:href="@{/my/review}">나의리뷰</a></li>
            <li><a th:href="@{/my/qna}" class="active">문의하기</a></li>
            <li><a th:href="@{/my/info}">나의설정</a></li>
        </ul>
    </div>

    <div class="content">
        <div class="main-content-header">
            <h2>나의 쇼핑 정보</h2>
            <div class="info-summary">
                <div class="info-item">
                    <div class="count" th:text="${orderCount}">2</div>
                    <div>주문</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${couponCount}">1</div>
                    <div>쿠폰</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${#numbers.formatInteger(pointTotal, 0, 'COMMA')}">1,000</div>
                    <div>포인트</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${qnaCount}">1</div>
                    <div>문의</div>
                </div>
            </div>
        </div>

        <!-- 배너 -->
        <div class="banner" th:if="${banner != null}" th:style="'background-color:' + ${banner.ban_bg_color}">
            <img th:if="${banner.ban_img != null}"
                 th:src="@{${banner.ban_img}}"
                 alt="배너" style="width:100%; height:100%; object-fit:cover;">
            <span th:if="${banner.ban_img == null}">810 x 86 배너 광고</span>
        </div>
        <h3>문의내역</h3>
        <table class="qna-table">
            <thead>
            <tr>
                <th>번호</th>
                <th>문의채널</th>
                <th>문의유형</th>
                <th>제목</th>
                <th>작성일시</th>  <!-- ✅ "작성일" → "작성일시" -->
                <th>상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="qna, status : ${qnaPage.content}">
                <td th:text="${status.count}">1</td>
                <td th:text="${qna.q_cate1}">고객센터</td>
                <td th:text="${qna.q_cate2}">주문 / 결제</td>
                <td th:text="${qna.q_title}">신용카드 결제 중 오류가 난 경우 어떻게 하나요?</td>
                <!-- ✅ 시분 포함 표시 (Service에서 이미 포맷됨) -->
                <td th:text="${qna.q_rdate}">2022-12-12 14:30</td>
                <td>
                    <span th:if="${#strings.isEmpty(qna.q_reply)}" class="status pending">검토 중</span>
                    <span th:unless="${#strings.isEmpty(qna.q_reply)}" class="status completed">
            답변 완료
            <button type="button"
                    th:attr="data-reply=${qna.q_reply}"
                    onclick="openQnaReply(this)">보기</button>
        </span>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(qnaPage.content)}">
                <td colspan="6" style="text-align: center;">문의 내역이 없습니다.</td>
            </tr>
            </tbody>
        </table>

        <!-- 페이지네이션 -->
        <div style="text-align: center; margin: 30px 0; padding: 20px; background: #f9f9f9; border-radius: 8px;">
            <!-- 첫 페이지 -->
            <a th:if="${qnaPage.number > 0}"
               th:href="@{/my/qna(page=0)}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                      border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                      background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">«</a>
            <span th:unless="${qnaPage.number > 0}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                        border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                        background: #f5f5f5; color: #ccc; font-weight: bold;">«</span>

            <!-- 이전 페이지 -->
            <a th:if="${qnaPage.hasPrevious()}"
               th:href="@{/my/qna(page=${qnaPage.number - 1})}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                      border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                      background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">‹</a>
            <span th:unless="${qnaPage.hasPrevious()}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                        border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                        background: #f5f5f5; color: #ccc; font-weight: bold;">‹</span>

            <!-- 페이지 번호 -->
            <th:block th:each="i : ${#numbers.sequence(0, qnaPage.totalPages - 1)}">
                <a th:if="${i != qnaPage.number}"
                   th:href="@{/my/qna(page=${i})}"
                   th:text="${i + 1}"
                   style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                          border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                          background: #fff; color: #555; text-decoration: none; font-weight: 600;"></a>
                <span th:if="${i == qnaPage.number}"
                      th:text="${i + 1}"
                      style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                            border: 1px solid #946ccf; border-radius: 6px; margin: 0 2px;
                            background: linear-gradient(135deg, #a86cc1, #946ccf); color: #fff;
                            font-weight: 700;"></span>
            </th:block>

            <!-- 다음 페이지 -->
            <a th:if="${qnaPage.hasNext()}"
               th:href="@{/my/qna(page=${qnaPage.number + 1})}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                      border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                      background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">›</a>
            <span th:unless="${qnaPage.hasNext()}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                        border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                        background: #f5f5f5; color: #ccc; font-weight: bold;">›</span>

            <!-- 마지막 페이지 -->
            <a th:if="${qnaPage.number < qnaPage.totalPages - 1}"
               th:href="@{/my/qna(page=${qnaPage.totalPages - 1})}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                      border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                      background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">»</a>
            <span th:unless="${qnaPage.number < qnaPage.totalPages - 1}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                        border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                        background: #f5f5f5; color: #ccc; font-weight: bold;">»</span>

            <div style="margin-top: 12px; font-size: 13px; color: #999;">
                <th:block th:text="${qnaPage.number + 1} + ' / ' + ${qnaPage.totalPages}"></th:block>
            </div>
        </div>
    </div>
</main>

<!-- 문의 답변 완료 모달 -->
<div id="qnaReplyModal" class="modal">
    <div class="modal-content">
        <div class="modal-body"></div>
        <button class="modal-confirm-btn" onclick="closeModal('qnaReplyModal')">확인</button>
    </div>
</div>


<div th:replace="~{my/_tail.html}"></div>

<script>
    function openModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.style.display = 'flex';
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.style.display = 'none';
    }

    window.addEventListener('click', function(e) {
        document.querySelectorAll('.modal').forEach(modal => {
            if (e.target === modal) modal.style.display = 'none';
        });
    });

    // Q&A 문의 등록
    document.addEventListener('DOMContentLoaded', function() {
        const qnaForm = document.querySelector('#qnaPopup form');
        if (qnaForm) {
            qnaForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const qnaType = document.querySelector('input[name="qna_type"]:checked');
                const title = document.querySelector('#qnaPopup input[type="text"]').value;
                const content = document.querySelector('#qnaPopup textarea').value;

                if (!qnaType) { alert('문의유형을 선택해주세요.'); return; }
                if (!title.trim()) { alert('제목을 입력해주세요.'); return; }
                if (!content.trim()) { alert('내용을 입력해주세요.'); return; }

                fetch('/my/qna/write', { method:'POST', body:new FormData(this) })
                    .then(res => res.text())
                    .then(data => {
                        if (data === 'success') {
                            alert('문의가 등록되었습니다.');
                            closeModal('qnaPopup');
                            this.reset();
                        } else { alert('문의 등록에 실패했습니다.'); }
                    })
                    .catch(err => { console.error(err); alert('오류가 발생했습니다.'); });
            });
        }
    });
    function openQnaReply(button) {
        const replyText = button.dataset.reply; // data-reply 가져오기
        const modal = document.getElementById('qnaReplyModal');
        modal.querySelector('.modal-body').textContent = replyText;
        openModal('qnaReplyModal');
    }


</script>
