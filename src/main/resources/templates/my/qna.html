<!-- qna.hmtl-->
<div th:replace="~{my/_head.html}"></div>

<main class="container">
    <div class="sidebar">
        <ul>
            <li><a th:href="@{/my/home}">마이페이지 홈</a></li>
            <li><a th:href="@{/my/order}">전체주문내역</a></li>
            <li><a th:href="@{/my/point}">포인트내역</a></li>
            <li><a th:href="@{/my/coupon}">쿠폰</a></li>
            <li><a th:href="@{/my/review}">나의리뷰</a></li>
            <li><a th:href="@{/my/qna}" class="active">문의하기</a></li>
            <li><a th:href="@{/my/info}">나의설정</a></li>
        </ul>
    </div>

    <div class="content">
        <div class="main-content-header">
            <h2>나의 쇼핑 정보</h2>
            <div class="info-summary">
                <div class="info-item">
                    <div class="count" th:text="${orderCount}">2</div>
                    <div>주문</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${couponCount}">1</div>
                    <div>쿠폰</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${#numbers.formatInteger(pointTotal, 0, 'COMMA')}">1,000</div>
                    <div>포인트</div>
                </div>
                <div class="info-item">
                    <div class="count" th:text="${qnaCount}">1</div>
                    <div>문의</div>
                </div>
            </div>
        </div>

        <!-- 배너 -->
        <div class="banner" th:if="${banner != null}" th:style="'background-color:' + ${banner.ban_bg_color}">
            <img th:if="${banner.ban_img != null}"
                 th:src="@{${banner.ban_img}}"
                 alt="배너" style="width:100%; height:100%; object-fit:cover;">
            <span th:if="${banner.ban_img == null}">810 x 86 배너 광고</span>
        </div>
        <h3>문의내역</h3>
        <table class="qna-table">
            <thead>
            <tr>
                <th>번호</th>
                <th>문의채널</th>
                <th>문의유형</th>
                <th>제목</th>
                <th>작성일시</th>  <!-- ✅ "작성일" → "작성일시" -->
                <th>상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="qna, status : ${qnaPage.content}">
                <td th:text="${status.count}">1</td>
                <td th:text="${qna.q_cate1}">고객센터</td>
                <td th:text="${qna.q_cate2}">주문 / 결제</td>
                <td th:text="${qna.q_title}">신용카드 결제 중 오류가 난 경우 어떻게 하나요?</td>
                <!-- ✅ 시분 포함 표시 (Service에서 이미 포맷됨) -->
                <td th:text="${qna.q_rdate}">2022-12-12 14:30</td>
                <td>
                    <span th:if="${#strings.isEmpty(qna.q_reply)}" class="status pending">검토 중</span>
                    <span th:unless="${#strings.isEmpty(qna.q_reply)}" class="status completed">
            답변 완료
            <button type="button"
                    th:attr="data-reply=${qna.q_reply}"
                    onclick="openQnaReply(this)">보기</button>
        </span>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(qnaPage.content)}">
                <td colspan="6" style="text-align: center;">문의 내역이 없습니다.</td>
            </tr>
            </tbody>
        </table>

        <!-- ✅ NEW: 계정정보 섹션 -->
        <!-- 계정정보 섹션 (qna.html에서 페이지네이션 위에 추가) -->
        <div class="account-info-section" style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee;">
            <h3 style="margin-bottom: 20px; font-size: 16px; font-weight: 700; color: #333;">계정정보</h3>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">

                <!-- 기본배송지 -->
                <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #666; text-transform: uppercase;">기본배송지설정</h4>
                        <a href="#" onclick="openAddressModal(); return false;" style="font-size: 12px; color: #946ccf; text-decoration: none; font-weight: 500;">변경</a>
                    </div>
                    <p style="margin: 5px 0; font-size: 12px; color: #999;">
                        <span id="dispZip" th:text="${memberInfo.mem_zip}">우편번호</span>
                    </p>
                    <p style="margin: 5px 0; font-size: 13px; color: #333; line-height: 1.4;">
                        <span id="dispAddr1" th:text="${memberInfo.mem_addr1}">기본주소</span>
                        <span id="dispAddr2" th:if="${memberInfo.mem_addr2}" th:text="${memberInfo.mem_addr2}"></span>
                    </p>
                </div>

                <!-- Email -->
                <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #666; text-transform: uppercase;">Email 설정</h4>
                        <a href="#" onclick="openEmailModal(); return false;" style="font-size: 12px; color: #946ccf; text-decoration: none; font-weight: 500;">변경</a>
                    </div>
                    <p style="margin: 5px 0; font-size: 13px; color: #333;">
                        <span id="dispEmail" th:text="${memberInfo.mem_email}">이메일</span>
                    </p>
                    <p style="margin: 5px 0; font-size: 12px; color: #999;">
                        (최종수정일 2021-12-10)
                    </p>
                </div>

                <!-- 휴대폰 -->
                <div style="padding: 15px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #666; text-transform: uppercase;">휴대폰 설정</h4>
                        <a href="#" onclick="openPhoneModal(); return false;" style="font-size: 12px; color: #946ccf; text-decoration: none; font-weight: 500;">변경</a>
                    </div>
                    <p style="margin: 5px 0; font-size: 13px; color: #333;">
                        <span id="dispPhone" th:text="${memberInfo.mem_hp}">휴대폰번호</span>
                    </p>
                    <p style="margin: 5px 0; font-size: 12px; color: #999;">
                        (최종수정일 2021-12-10)
                    </p>
                </div>

            </div>
        </div>
        <!-- 페이지네이션 -->
        <div style="text-align: center; margin: 30px 0; padding: 20px; background: #f9f9f9; border-radius: 8px;">
            <!-- 첫 페이지 -->
            <a th:if="${qnaPage.number > 0}"
               th:href="@{/my/qna(page=0)}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                      border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                      background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">«</a>
            <span th:unless="${qnaPage.number > 0}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                        border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                        background: #f5f5f5; color: #ccc; font-weight: bold;">«</span>

            <!-- 이전 페이지 -->
            <a th:if="${qnaPage.hasPrevious()}"
               th:href="@{/my/qna(page=${qnaPage.number - 1})}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                      border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                      background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">‹</a>
            <span th:unless="${qnaPage.hasPrevious()}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                        border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                        background: #f5f5f5; color: #ccc; font-weight: bold;">‹</span>

            <!-- 페이지 번호 -->
            <th:block th:each="i : ${#numbers.sequence(0, qnaPage.totalPages - 1)}">
                <a th:if="${i != qnaPage.number}"
                   th:href="@{/my/qna(page=${i})}"
                   th:text="${i + 1}"
                   style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                          border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                          background: #fff; color: #555; text-decoration: none; font-weight: 600;"></a>
                <span th:if="${i == qnaPage.number}"
                      th:text="${i + 1}"
                      style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                            border: 1px solid #946ccf; border-radius: 6px; margin: 0 2px;
                            background: linear-gradient(135deg, #a86cc1, #946ccf); color: #fff;
                            font-weight: 700;"></span>
            </th:block>

            <!-- 다음 페이지 -->
            <a th:if="${qnaPage.hasNext()}"
               th:href="@{/my/qna(page=${qnaPage.number + 1})}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                      border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                      background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">›</a>
            <span th:unless="${qnaPage.hasNext()}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                        border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                        background: #f5f5f5; color: #ccc; font-weight: bold;">›</span>

            <!-- 마지막 페이지 -->
            <a th:if="${qnaPage.number < qnaPage.totalPages - 1}"
               th:href="@{/my/qna(page=${qnaPage.totalPages - 1})}"
               style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                      border: 1px solid #ddd; border-radius: 6px; margin: 0 2px;
                      background: #fff; color: #946ccf; text-decoration: none; font-weight: bold;">»</a>
            <span th:unless="${qnaPage.number < qnaPage.totalPages - 1}"
                  style="display: inline-block; width: 36px; height: 36px; line-height: 36px;
                        border: 1px solid #e0e0e0; border-radius: 6px; margin: 0 2px;
                        background: #f5f5f5; color: #ccc; font-weight: bold;">»</span>

            <div style="margin-top: 12px; font-size: 13px; color: #999;">
                <th:block th:text="${qnaPage.number + 1} + ' / ' + ${qnaPage.totalPages}"></th:block>
            </div>
        </div>
    </div>
</main>
<!-- 주소 변경 모달 -->
<div id="addressModal" class="modal">
    <div class="modal-content" style="width: 500px;">
        <div class="modal-header">
            <h4>배송지 수정</h4>
            <span class="close-btn" onclick="closeModal('addressModal')">&times;</span>
        </div>
        <div style="padding: 20px;">
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <input type="text" id="zipcode" placeholder="우편번호" readonly style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <button type="button" onclick="searchAddress()" style="padding: 8px 15px; background: #946ccf; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">주소검색</button>
            </div>
            <input type="text" id="addr1" placeholder="기본주소" readonly style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box;">
            <input type="text" id="addr2" placeholder="상세주소" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; box-sizing: border-box;">
            <div style="text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
                <button type="button" onclick="saveAddress()" style="padding: 8px 15px; background: #946ccf; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">저장</button>
                <button type="button" onclick="closeModal('addressModal')" style="padding: 8px 15px; background: #f0f0f0; color: #333; border: none; border-radius: 4px; cursor: pointer;">취소</button>
            </div>
        </div>
    </div>
</div>

<!-- 이메일 변경 모달 -->
<div id="emailModal" class="modal">
    <div class="modal-content" style="width: 450px;">
        <div class="modal-header">
            <h4>Email 수정</h4>
            <span class="close-btn" onclick="closeModal('emailModal')">&times;</span>
        </div>
        <div style="padding: 20px;">
            <div style="display: flex; gap: 5px; margin-bottom: 20px; align-items: center;">
                <input type="text" id="emailId" placeholder="이메일ID" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <span style="font-weight: 600;">@</span>
                <select id="emailDomain" onchange="checkEmailDomain()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 120px;">
                    <option value="naver.com">naver.com</option>
                    <option value="gmail.com">gmail.com</option>
                    <option value="daum.net">daum.net</option>
                    <option value="self">직접입력</option>
                </select>
                <input type="text" id="emailInput" placeholder="도메인" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; display: none;">
            </div>
            <div style="text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
                <button type="button" onclick="saveEmail()" style="padding: 8px 15px; background: #946ccf; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">저장</button>
                <button type="button" onclick="closeModal('emailModal')" style="padding: 8px 15px; background: #f0f0f0; color: #333; border: none; border-radius: 4px; cursor: pointer;">취소</button>
            </div>
        </div>
    </div>
</div>

<!-- 휴대폰 변경 모달 -->
<div id="phoneModal" class="modal">
    <div class="modal-content" style="width: 400px;">
        <div class="modal-header">
            <h4>휴대폰 수정</h4>
            <span class="close-btn" onclick="closeModal('phoneModal')">&times;</span>
        </div>
        <div style="padding: 20px;">
            <div style="display: flex; gap: 5px; margin-bottom: 20px; justify-content: center; align-items: center;">
                <input type="text" id="hp1" placeholder="010" maxlength="3" style="width: 50px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                <span style="font-weight: 600; color: #666;">-</span>
                <input type="text" id="hp2" placeholder="1234" maxlength="4" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
                <span style="font-weight: 600; color: #666;">-</span>
                <input type="text" id="hp3" placeholder="5678" maxlength="4" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;">
            </div>
            <div style="text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
                <button type="button" onclick="savePhone()" style="padding: 8px 15px; background: #946ccf; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">저장</button>
                <button type="button" onclick="closeModal('phoneModal')" style="padding: 8px 15px; background: #f0f0f0; color: #333; border: none; border-radius: 4px; cursor: pointer;">취소</button>
            </div>
        </div>
    </div>
</div>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<!-- 문의 답변 완료 모달 -->
<div id="qnaReplyModal" class="modal">
    <div class="modal-content">
        <div class="modal-body"></div>
        <button class="modal-confirm-btn" onclick="closeModal('qnaReplyModal')">확인</button>
    </div>
</div>


<div th:replace="~{my/_tail.html}"></div>

<script>
    // ===== 모달 공통 함수 =====
    function openModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.style.display = 'flex';
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) modal.style.display = 'none';
    }

    window.addEventListener('click', function(e) {
        document.querySelectorAll('.modal').forEach(modal => {
            if (e.target === modal) modal.style.display = 'none';
        });
    });

    // ===== 주소 변경 =====
    function openAddressModal() {
        const zip = document.getElementById('dispZip').textContent.trim();
        const addr1 = document.getElementById('dispAddr1').textContent.trim();
        const addr2 = document.getElementById('dispAddr2') ? document.getElementById('dispAddr2').textContent.trim() : '';

        document.getElementById('zipcode').value = zip;
        document.getElementById('addr1').value = addr1;
        document.getElementById('addr2').value = addr2;

        openModal('addressModal');
    }

    function searchAddress() {
        if (typeof daum === 'undefined' || !daum.Postcode) {
            alert('주소 검색 서비스를 불러오는 중입니다. 잠시 후 다시 시도해주세요.');
            return;
        }

        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('addr1').value = data.address;
                document.getElementById('zipcode').value = data.zonecode;
            }
        }).open();
    }

    function saveAddress() {
        const zip = document.getElementById('zipcode').value.trim();
        const addr1 = document.getElementById('addr1').value.trim();
        const addr2 = document.getElementById('addr2').value.trim();

        if (!zip || !addr1) {
            alert('주소를 선택해주세요.');
            return;
        }

        const memberData = {
            mem_zip: zip,
            mem_addr1: addr1,
            mem_addr2: addr2,
            mem_email: document.getElementById('dispEmail').textContent.trim(),
            mem_hp: document.getElementById('dispPhone').textContent.trim()
        };

        fetch('/shoply/my/info/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(memberData)
        })
            .then(res => res.text())
            .then(data => {
                if (data === 'success') {
                    alert('주소가 수정되었습니다.');
                    document.getElementById('dispZip').textContent = zip;
                    document.getElementById('dispAddr1').textContent = addr1;
                    if (document.getElementById('dispAddr2')) {
                        document.getElementById('dispAddr2').textContent = addr2;
                    }
                    closeModal('addressModal');
                } else {
                    alert('수정 실패');
                }
            })
            .catch(err => {
                console.error(err);
                alert('오류가 발생했습니다.');
            });
    }

    // ===== 이메일 변경 =====
    function openEmailModal() {
        const email = document.getElementById('dispEmail').textContent.trim();
        const [emailId, emailDomain] = email.split('@');

        document.getElementById('emailId').value = emailId || '';

        const domainSelect = document.getElementById('emailDomain');
        if (emailDomain === 'naver.com' || emailDomain === 'gmail.com' || emailDomain === 'daum.net') {
            domainSelect.value = emailDomain;
            document.getElementById('emailInput').style.display = 'none';
        } else {
            domainSelect.value = 'self';
            document.getElementById('emailInput').value = emailDomain || '';
            document.getElementById('emailInput').style.display = 'inline-block';
        }

        openModal('emailModal');
    }

    function checkEmailDomain() {
        document.getElementById('emailInput').style.display =
            document.getElementById('emailDomain').value === 'self' ? 'inline-block' : 'none';
    }

    function saveEmail() {
        const emailId = document.getElementById('emailId').value.trim();
        const domain = document.getElementById('emailDomain').value === 'self'
            ? document.getElementById('emailInput').value.trim()
            : document.getElementById('emailDomain').value;

        if (!emailId || !domain) {
            alert('이메일을 올바르게 입력해주세요.');
            return;
        }

        const newEmail = `${emailId}@${domain}`;
        const memberData = {
            mem_email: newEmail,
            mem_zip: document.getElementById('dispZip').textContent.trim(),
            mem_addr1: document.getElementById('dispAddr1').textContent.trim(),
            mem_addr2: document.getElementById('dispAddr2') ? document.getElementById('dispAddr2').textContent.trim() : '',
            mem_hp: document.getElementById('dispPhone').textContent.trim()
        };

        fetch('/shoply/my/info/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(memberData)
        })
            .then(res => res.text())
            .then(data => {
                if (data === 'success') {
                    alert('이메일이 수정되었습니다.');
                    document.getElementById('dispEmail').textContent = newEmail;
                    closeModal('emailModal');
                } else {
                    alert('수정 실패');
                }
            })
            .catch(err => {
                console.error(err);
                alert('오류가 발생했습니다.');
            });
    }

    // ===== 휴대폰 변경 =====
    function openPhoneModal() {
        const phone = document.getElementById('dispPhone').textContent.trim();
        const [hp1, hp2, hp3] = phone.split('-');

        document.getElementById('hp1').value = hp1 || '';
        document.getElementById('hp2').value = hp2 || '';
        document.getElementById('hp3').value = hp3 || '';

        openModal('phoneModal');
    }

    function savePhone() {
        const hp1 = document.getElementById('hp1').value.trim();
        const hp2 = document.getElementById('hp2').value.trim();
        const hp3 = document.getElementById('hp3').value.trim();

        if (!hp1 || !hp2 || !hp3) {
            alert('휴대폰 번호를 올바르게 입력해주세요.');
            return;
        }

        if (hp1.length < 2 || hp2.length < 3 || hp3.length < 4) {
            alert('휴대폰 번호를 다시 확인해주세요.');
            return;
        }

        const newPhone = `${hp1}-${hp2}-${hp3}`;
        const memberData = {
            mem_hp: newPhone,
            mem_zip: document.getElementById('dispZip').textContent.trim(),
            mem_addr1: document.getElementById('dispAddr1').textContent.trim(),
            mem_addr2: document.getElementById('dispAddr2') ? document.getElementById('dispAddr2').textContent.trim() : '',
            mem_email: document.getElementById('dispEmail').textContent.trim()
        };

        fetch('/shoply/my/info/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(memberData)
        })
            .then(res => res.text())
            .then(data => {
                if (data === 'success') {
                    alert('휴대폰이 수정되었습니다.');
                    document.getElementById('dispPhone').textContent = newPhone;
                    closeModal('phoneModal');
                } else {
                    alert('수정 실패');
                }
            })
            .catch(err => {
                console.error(err);
                alert('오류가 발생했습니다.');
            });
    }
</script>